<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Transport | Poortjie Services</title>
    <meta name="description"
          content="Check local public transport information, routes, fares, and operating hours in Poortjie (Taxis & Buses).">
    <meta name="theme-color" content="#22c55e">

    <link rel="icon" type="image/png" sizes="48x48" href="../favicon/favicon-48x48.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../favicon/favicon-96x96.png">
    <link rel="icon" type="image/svg+xml" href="../favicon/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        if (window.console && window.console.log) { const originalLog = window.console.log; window.console.log = function() { if (arguments[0] && typeof arguments[0] === "string" && (arguments[0].includes("cdn.tailwindcss.com should not be used in production") || arguments[0].includes("Tailwind CSS: You should not use the CDN"))) return; originalLog.apply(window.console, arguments); }; } tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="../styles/main.css">
    <style>
        @keyframes pulse-red {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }

        .breaking-news-badge {
            animation: pulse-red 2s infinite;
        }

        .marquee-container {
            overflow: hidden;
            white-space: nowrap;
            background: #ef4444;
            color: white;
            padding: 10px 0;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 24px 40px -24px rgb(0 0 0 / 0.1);
        }

        .marquee-content {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 20s linear infinite;
        }

        @keyframes marquee {
            0% {
                transform: translate(0, 0);
            }
            100% {
                transform: translate(-100%, 0);
            }
        }
    </style>
    <link rel="manifest" href="../favicon/site.webmanifest">
</head>
<body class="font-sans antialiased bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100">

<header class="max-w-6xl mx-auto pt-20 pb-12 px-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
        <div>
            <div class="bg-green-500 text-white px-4 py-1 rounded-full text-sm font-bold tracking-widest uppercase inline-block">
                Transport
            </div>
            <h1 class="text-4xl md:text-6xl font-extrabold mt-2 tracking-tight">Public Transport</h1>
        </div>
        <a
                href="../index.html"
                onclick="if(history.length > 1) { history.back(); return false; } else { window.top.location.replace('../index.html'); return false; }"
                class="w-full md:w-auto text-center px-6 py-3 border-2 border-green-600 text-green-600 dark:text-green-400 font-bold rounded-lg hover:bg-green-600 hover:text-white transition whitespace-nowrap">
            <i class="fas fa-arrow-left mr-2"></i>Go Back
        </a>
    </div>
</header>

<main class="max-w-6xl mx-auto px-6 pb-24">
    <!-- News Section -->
    <div id="news-section" class="mb-12 hidden">
        <div id="news-marquee" class="marquee-container hidden">
            <div id="marquee-text" class="marquee-content">
                <!-- Scrolling news items will be injected here -->
            </div>
        </div>

        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold flex items-center gap-3">
                <span class="w-8 h-1 bg-green-500"></span> Latest Updates
            </h2>
            <span id="breaking-badge"
                  class="hidden breaking-news-badge bg-red-600 text-white text-[10px] font-black px-2 py-1 rounded uppercase tracking-tighter">Breaking News</span>
        </div>

        <div id="news-container" class="grid grid-cols-1 gap-4">
            <!-- News items will be injected here -->
        </div>
    </div>

    <!-- Tabs Section -->
    <div class="flex border-b border-gray-200 dark:border-slate-800 mb-8">
        <button id="tab-taxis" class="px-6 py-3 font-bold text-lg border-b-4 border-green-500 text-green-600 dark:text-green-400">
            <i class="fas fa-taxi mr-2"></i>Taxis
        </button>
        <button id="tab-buses" class="px-6 py-3 font-bold text-lg border-b-4 border-transparent text-gray-500 hover:text-green-500 transition">
            <i class="fas fa-bus mr-2"></i>Buses
        </button>
    </div>

    <h2 id="grid-title" class="text-2xl font-bold mb-6 flex items-center gap-3">
        <span class="w-8 h-1 bg-green-500"></span> Taxi Routes & Fares
    </h2>
    <div id="routes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Routes will be injected here -->
        <div class="col-span-full text-center py-12">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-green-500 border-t-transparent rounded-full mb-4"></div>
            <p>Loading routes...</p>
        </div>
    </div>
</main>

<footer class="text-center py-12 border-t border-gray-100 dark:border-slate-800 opacity-50 text-xs">
    &copy; 2026 Poortjie Services. Empowering poortjie economies.<br><a href="../support.html" class="hover:underline">Data Policy</a>
</footer>

<script src="../scripts/theme.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="../scripts/firebase.js"></script>

<script>
    const routesGrid = document.getElementById('routes-grid');
    const newsSection = document.getElementById('news-section');
    const newsContainer = document.getElementById('news-container');
    const tabTaxis = document.getElementById('tab-taxis');
    const tabBuses = document.getElementById('tab-buses');
    const gridTitle = document.getElementById('grid-title');

    let currentMode = 'taxis'; // 'taxis' or 'buses'
    let allData = { news: [], routes: {}, bus_routes: {} };

    tabTaxis.addEventListener('click', () => switchTab('taxis'));
    tabBuses.addEventListener('click', () => switchTab('buses'));

    function switchTab(mode) {
        currentMode = mode;
        
        // Update UI tabs
        if (mode === 'taxis') {
            tabTaxis.className = 'px-6 py-3 font-bold text-lg border-b-4 border-green-500 text-green-600 dark:text-green-400';
            tabBuses.className = 'px-6 py-3 font-bold text-lg border-b-4 border-transparent text-gray-500 hover:text-green-500 transition';
            gridTitle.innerHTML = '<span class="w-8 h-1 bg-green-500"></span> Taxi Routes & Fares';
            renderRoutes(allData.routes);
        } else {
            tabBuses.className = 'px-6 py-3 font-bold text-lg border-b-4 border-green-500 text-green-600 dark:text-green-400';
            tabTaxis.className = 'px-6 py-3 font-bold text-lg border-b-4 border-transparent text-gray-500 hover:text-green-500 transition';
            gridTitle.innerHTML = '<span class="w-8 h-1 bg-green-500"></span> Bus Routes & Fares';
            renderRoutes(allData.bus_routes || {});
        }
    }

    function goBack() {
        if (document.referrer.indexOf(window.location.host) !== -1) {
            history.back();
        } else {
            window.location.href = '/';
        }
    }

    async function fetchRoutes() {
        try {
            const doc = await db.collection('poortjie').doc('taxi_routes').get();
            if (doc.exists) {
                allData = doc.data();
                if (allData.news && allData.news.length > 0) {
                    renderNews(allData.news);
                } else {
                    renderNoNews();
                }
                
                if (currentMode === 'taxis') {
                    if (allData.routes) {
                        renderRoutes(allData.routes);
                    } else {
                        routesGrid.innerHTML = '<p class="col-span-full text-center py-12 opacity-60">No taxi routes found.</p>';
                    }
                } else {
                    if (allData.bus_routes) {
                        renderRoutes(allData.bus_routes);
                    } else {
                        routesGrid.innerHTML = '<p class="col-span-full text-center py-12 opacity-60">No bus routes found.</p>';
                    }
                }
            } else {
                routesGrid.innerHTML = '<p class="col-span-full text-center py-12 opacity-60">No public transport data found.</p>';
                renderNoNews();
            }
        } catch (error) {
            console.error("Error fetching routes:", error);
            routesGrid.innerHTML = '<p class="col-span-full text-center py-12 text-red-500">Failed to load routes. Please try again later.</p>';
            renderNoNews();
        }
    }

    function renderNoNews() {
        document.getElementById('news-marquee')?.classList.add('hidden');
        document.getElementById('breaking-badge')?.classList.add('hidden');
        newsContainer.innerHTML = `
            <div class="p-8 border-2 border-dashed border-gray-200 dark:border-slate-800 rounded-2xl text-center">
                <i class="fas fa-newspaper text-3xl text-gray-300 dark:text-slate-700 mb-3 block"></i>
                <p class="text-sm opacity-60">If there are any news or updates (like fare raises), they will appear here. Currently, everything is running smoothly!</p>
            </div>
        `;
        newsSection.classList.remove('hidden');
    }

    function renderNews(news) {
        newsContainer.innerHTML = '';
        const marqueeText = document.getElementById('marquee-text');
        const newsMarquee = document.getElementById('news-marquee');
        const breakingBadge = document.getElementById('breaking-badge');

        marqueeText.innerHTML = news.join(' • ') + ' • ';
        newsMarquee.classList.remove('hidden');
        breakingBadge.classList.remove('hidden');

        news.forEach(item => {
            const div = document.createElement('div');
            div.className = 'p-6 bg-gradient-to-r from-green-50 to-white dark:from-green-900/20 dark:to-slate-800 border-l-8 border-green-500 rounded-xl shadow-lg transform hover:scale-[1.01] transition duration-300';
            div.innerHTML = `
                <div class="flex items-start gap-4">
                    <div class="bg-green-500 text-white p-3 rounded-full shrink-0 shadow-lg">
                        <i class="fas fa-bullhorn text-xl"></i>
                    </div>
                    <div>
                        <p class="text-lg font-bold text-slate-800 dark:text-slate-100 leading-tight">${item}</p>
                        <p class="text-xs mt-2 opacity-50 font-bold uppercase tracking-widest">Confirmed Official Update</p>
                    </div>
                </div>
            `;
            newsContainer.appendChild(div);
        });
        newsSection.classList.remove('hidden');
    }

    function renderRoutes(routes) {
        routesGrid.innerHTML = '';

        // Convert routes object to array and sort by destination
        const sortedRoutes = Object.keys(routes).map(key => ({
            id: key,
            ...routes[key]
        })).sort((a, b) => a.destination.localeCompare(b.destination));

        sortedRoutes.forEach(route => {
            const card = document.createElement('div');
            card.className = 'card p-6 rounded-2xl border-l-4 border-l-green-500 flex flex-col shadow-sm hover:shadow-md transition';

            let rankAction = '';
            if (route.returns) {
                if (route.lat && route.lng) {
                    rankAction = `onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${route.lat},${route.lng}&travelmode=driving', '_blank')"`;
                } else {
                    rankAction = `onclick="alert('${route.location || 'Location is not confirmed yet.'}')"`;
                }
            }

            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-bold">
                        ${route.origin} 
                        <i class="fas ${route.returns ? 'fa-exchange-alt' : 'fa-arrow-right'} text-xs mx-1 opacity-50"></i> 
                        ${route.destination}
                    </h3>
                    <span class="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-3 py-1 rounded-full text-sm font-bold">R${route.fare}</span>
                </div>
                <div class="space-y-3 mb-6 flex-grow">
                    <div class="flex items-center gap-3 text-sm">
                        <i class="fas fa-clock w-5 text-green-500"></i>
                        <span>${route.hours}</span>
                    </div>

                    <div class="flex items-center gap-3 text-sm">
                        <i class="fas fa-info-circle w-5 text-green-500"></i>
                        <span class="capitalize">${route.type.replace('_', ' ')}</span>
                    </div>

                    ${route.location ? `
                    <div class="flex items-center gap-3 text-sm">
                        <i class="fas fa-map-marker-alt w-5 text-green-500"></i>
                        <span>${route.location}</span>
                    </div>
                    ` : ''}
                </div>
                ${route.returns ? `
                <button ${rankAction} class="w-full py-2 bg-slate-100 dark:bg-slate-800 hover:bg-green-600 hover:text-white transition rounded-lg font-bold text-sm">
                    Go to ${route.destination} rank
                </button>
                ` : ''}
            `;
            routesGrid.appendChild(card);
        });
    }

    fetchRoutes();
</script>
</body>
</html>
