<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Listing | Poortjie Services</title>
    <meta name="author" content="Musa Mgijima">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Disable Tailwind production warning
        if (window.console && window.console.log) {
            const originalLog = window.console.log;
            window.console.log = function() {
                if (arguments[0] && typeof arguments[0] === 'string' && (arguments[0].includes('cdn.tailwindcss.com should not be used in production') || arguments[0].includes('Tailwind CSS: You should not use the CDN'))) {
                    return;
                }
                originalLog.apply(window.console, arguments);
            };
        }
    </script>
    <script>
        // Use production-ready configuration when possible
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="icon" type="image/png" sizes="48x48" href="../favicon/favicon-48x48.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../favicon/favicon-96x96.png">
    <link rel="icon" type="image/svg+xml" href="../favicon/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png">
    <link rel="manifest" href="../favicon/site.webmanifest">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
          integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <script src="../scripts/loader.js"></script>
    <script src="../scripts/time-schedule.js"></script>
</head>
<body class="font-sans antialiased bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100">


<header class="max-w-6xl mx-auto pt-24 pb-16 px-6 text-center text-gray-900 dark:text-gray-100">
    <a href="../index.html"
       onclick="if(history.length > 1) { history.back(); return false; } else { window.top.location.replace('../index.html'); return false; }"
       class="text-6xl font-extrabold mb-4 tracking-tight">Poortjie</a>
</header>

<main class="max-w-6xl mx-auto px-6 pb-24">
    <div id="form-container" class="hidden lg:grid-cols-2 lg:gap-12 items-start">
        <!-- Left Column: Form -->
        <div class="card flex flex-col p-8 rounded-2xl border-l-4 border-l-green-500 w-full lg:max-w-none max-w-xl mx-auto">
            <div id="applications-section" class="mb-12 hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-center lg:text-left">My Applications</h2>
                    <button id="new-listing-btn" class="w-full sm:w-auto px-6 py-2.5 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition flex items-center justify-center gap-2 shadow-lg shadow-green-500/20">
                        <i class="fa-solid fa-plus"></i>
                        New Listing
                    </button>
                </div>
                <div id="user-applications-list" class="space-y-4"></div>
                <hr class="my-8 border-gray-200 dark:border-slate-700">
            </div>

            <div id="form-content-wrapper">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="form-title" class="text-2xl font-bold text-center lg:text-left">Business Listing</h2>
                    <button id="cancel-form-btn" class="hidden text-sm font-bold text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white transition flex items-center gap-1">
                        <i class="fa-solid fa-xmark"></i> Cancel
                    </button>
                </div>
                <div id="status-container" class="hidden text-center lg:text-left mb-4 space-y-2"></div>
                <div id="pending-status-container" class="hidden space-y-4 mb-8"></div>
                <p id="form-description" class="text-center lg:text-left opacity-70 mb-8">Fill in the details below to list your business on Poortjie Services.</p>

                <form id="business-form" novalidate>
            <div class="form-group mb-4">
                <label for="owner-name" class="block mb-1 font-bold text-sm uppercase tracking-wider">Full Name</label>
                <div class="relative">
                    <input type="text" id="owner-name" name="owner_name" maxlength="50"
                           placeholder="Enter your full name"
                           class="w-full p-3 rounded-lg bg-gray-100 dark:bg-slate-700 cursor-not-allowed text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition"
                           readonly>
                </div>
                <p id="owner-name-error" class="text-red-500 text-[10px] font-bold mt-1 hidden">Full Name is required</p>
            </div>

            <div class="form-group mb-4">
                <label for="email" class="block mb-1 font-bold text-sm uppercase tracking-wider">Email</label>
                <div class="relative">
                    <input type="email" id="email" name="email" placeholder="Enter your email"
                           class="w-full p-3 rounded-lg bg-gray-100 dark:bg-slate-700 cursor-not-allowed text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition"
                           readonly>
                </div>
                <p id="email-error" class="text-red-500 text-[10px] font-bold mt-1 hidden">Please enter a valid email address</p>
            </div>

            <div class="form-group mb-4">
                <label for="phone" class="block mb-1 font-bold text-sm uppercase tracking-wider">Phone Number</label>
                <div class="relative">
                    <input type="tel" id="phone" name="phone" placeholder="e.g. 0721234567" maxlength="10"
                           class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
                </div>
                <p id="phone-error" class="text-red-500 text-[10px] font-bold mt-1 hidden">Please enter a valid 10-digit phone number</p>
            </div>

            <div class="form-group mb-4">
                <label for="business-name" class="block mb-1 font-bold text-sm uppercase tracking-wider">Business
                    Name</label>
                <div class="relative">
                    <input type="text" id="business-name" name="business_name" maxlength="50"
                           placeholder="What is your business called?"
                           class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
                </div>
                <p id="business-name-error" class="text-red-500 text-[10px] font-bold mt-1 hidden">Business Name is required</p>
            </div>

            <div class="form-group mb-4">
                <label for="sub-heading" class="block mb-1 font-bold text-sm uppercase tracking-wider">Sub
                    Heading</label>
                <input type="text" id="sub-heading" name="sub_heading" maxlength="100"
                       placeholder="e.g. Your slogan"
                       class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
            </div>

            <div class="form-group mb-4">
                <label for="business-type" class="block mb-1 font-bold text-sm uppercase tracking-wider">Type of
                    Business</label>
                <div class="relative">
                    <select id="business-type" name="business_type"
                            class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
                        <option value="" disabled selected>Select a category</option>
                    </select>
                </div>
                <p id="business-type-error" class="text-red-500 text-[10px] font-bold mt-1 hidden">Please select a business category</p>
            </div>

            <div class="form-group mb-4">
                <label for="address" class="block mb-1 font-bold text-sm uppercase tracking-wider">Business
                    Address</label>
                <div class="relative">
                    <input type="text" id="address" name="address" placeholder="Poortjie" value="Poortjie" readonly
                           class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition cursor-pointer">
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 text-green-600">
                        <i class="fa-solid fa-map-location-dot"></i>
                    </div>
                </div>
                <p id="address-error" class="text-red-500 text-[10px] font-bold mt-1 hidden">Please pin your exact business location on the map</p>
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
            </div>

            <div class="form-group mb-4">
                <label class="block mb-1 font-bold text-sm uppercase tracking-wider">Social Links & Website</label>
                <button type="button" id="open-social-modal"
                        class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent hover:border-green-500 focus:outline-none transition flex items-center justify-between">
                    <span id="social-links-summary" class="opacity-70">Add WhatsApp, Facebook, Website</span>
                    <i class="fa-solid fa-share-nodes text-green-600"></i>
                </button>
                <input type="hidden" id="website" name="website">
                <input type="hidden" id="whatsapp" name="whatsapp">
                <input type="hidden" id="facebook" name="facebook">
            </div>

            <div class="form-group mb-4">
                <label for="hours-type" class="block mb-1 font-bold text-sm uppercase tracking-wider">Operating Hours</label>
                <div class="space-y-3">
                    <select id="hours-type" name="hours_type"
                            class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
                        <option value="always">Always Open</option>
                        <option value="selected">Selected Hours</option>
                        <option value="appointment">By Appointment Only</option>
                        <option value="custom">Custom Text</option>
                    </select>
                    
                    <div id="selected-hours-container" class="hidden animate-fadeIn bg-gray-50 dark:bg-slate-800/50 p-4 rounded-xl border border-gray-100 dark:border-slate-700">
                        <time-schedule id="time-schedule-component"></time-schedule>
                    </div>

                    <label for="hours"></label><input type="text" id="hours" name="hours" maxlength="100" placeholder="e.g. Mon-Fri 9am-5pm"
                                                      class="hidden w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
                </div>
            </div>

            <div class="form-group mb-6">
                <label for="description" class="block mb-1 font-bold text-sm uppercase tracking-wider">Business
                    Description</label>
                <div class="relative">
                    <textarea id="description" name="description" maxlength="200"
                              placeholder="Tell us what your business is about..."
                              class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition"
                              rows="4"></textarea>
                    <div id="description-counter" class="absolute right-2 bottom-2 text-[10px] opacity-40 font-mono">
                        0/200
                    </div>
                </div>
                <p id="description-error" class="text-red-500 text-[10px] font-bold mt-1 hidden">Please provide a brief description of your business</p>
            </div>

            <!-- Services/Price List Section -->
            <div class="form-group mb-6">
                <div class="flex justify-between items-center mb-2">
                    <label class="block font-bold text-sm uppercase tracking-wider">Services / Price List</label>
                    <button type="button" id="add-service-btn" class="text-xs bg-green-600 text-white px-2 py-1 rounded font-bold hover:bg-green-700 transition">
                        <i class="fas fa-plus mr-1"></i> Add Service
                    </button>
                </div>
                <div id="services-list" class="space-y-3">
                    <!-- Dynamic service rows will be added here -->
                </div>
                <p class="text-[10px] mt-2 opacity-50 italic">Optional: List what you do and how much it costs.</p>
            </div>

            <!-- Photos Section -->
            <div id="photos-section" class="form-group mb-6">
                <div class="flex justify-between items-center mb-2">
                    <label class="block font-bold text-sm uppercase tracking-wider">Business Photos</label>
                    <button type="button" id="open-gallery-btn" class="text-xs bg-green-600 text-white px-2 py-1 rounded font-bold hover:bg-green-700 transition">
                        <i class="fas fa-camera mr-1"></i> Add Photos
                    </button>
                </div>
                <div id="photos-summary" class="flex gap-2 overflow-x-auto pb-2">
                    <!-- Photo thumbnails will appear here -->
                    <p class="text-xs opacity-50 italic py-2">No photos added yet (max 5).</p>
                </div>
                <input type="hidden" id="business-photos" name="photos">
            </div>

        </form>
            </div>
        </div>

        <!-- Right Column: Preview -->
        <div id="preview-container" class="lg:sticky lg:top-24 mt-12 lg:mt-0 pt-12 lg:pt-0 border-t lg:border-t-0 border-gray-100 dark:border-slate-700 hidden">
            <h3 class="text-xl font-bold mb-6 text-center">Preview Your Listing</h3>
            <div id="card-preview" class="max-w-sm mx-auto">
            </div>
            <p class="text-xs text-center opacity-50 my-6 italic">Note: Rating and comments are for display purposes in
                this preview.</p>

            <div id="submit-btn-wrapper" class="w-full">
                <button type="submit" form="business-form" id="submit-btn"
                        class="w-full px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition shadow-md opacity-50 cursor-not-allowed">
                    Submit Business Details
                </button>
            </div>
        </div>
    </div>
</main>

<footer class="text-center py-12 border-t border-gray-100 dark:border-slate-800 opacity-50 text-xs">
    &copy; 2026 Poortjie Services. Empowering poortjie economies.<br><a href="../support.html" class="hover:underline">Data Policy</a>
</footer>

<!-- Modals -->
<div id="address-modal"
     class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-lg overflow-hidden shadow-2xl border border-gray-100 dark:border-slate-800">
        <div class="p-6 border-b border-gray-100 dark:border-slate-800 flex justify-between items-center">
            <h3 class="text-xl font-bold">Business Location</h3>
            <button type="button" id="close-address-modal"
                    class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white transition">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
        <div class="p-6 space-y-4">
            <div class="form-group">
                <label for="modal-address"
                       class="block mb-1 font-bold text-xs uppercase tracking-wider opacity-70">Type your address</label>
                <input type="text" id="modal-address" placeholder="Start typing your address..."
                       class="w-full p-3 rounded-lg bg-gray-100 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
            </div>
            
            <div class="space-y-2">
                <h4 class="font-bold text-sm uppercase tracking-wider opacity-70">Is your location correct on map?</h4>
                <div id="map" class="w-full h-64 rounded-xl border-2 border-gray-100 dark:border-slate-800"></div>
                <p class="text-[10px] text-gray-500 italic text-center">Drag the pin to your exact location (restricted to 5km radius)</p>
            </div>
        </div>
        <div class="p-6 bg-gray-50 dark:bg-slate-800/50">
            <button type="button" id="confirm-address"
                    class="w-full py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition">
                Confirm Location
            </button>
        </div>
    </div>
</div>

<div id="social-modal"
     class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md overflow-hidden shadow-2xl border border-gray-100 dark:border-slate-800">
        <div class="p-6 border-b border-gray-100 dark:border-slate-800 flex justify-between items-center">
            <h3 class="text-xl font-bold">Social Links</h3>
            <button type="button" id="close-social-modal"
                    class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white transition">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
        <div class="p-6 space-y-4">
            <div class="form-group">
                <label for="modal-whatsapp"
                       class="block mb-1 font-bold text-xs uppercase tracking-wider opacity-70">WhatsApp
                    Number</label>
                <div class="relative">
                    <i class="fa-brands fa-whatsapp absolute left-3 top-3.5 text-green-500"></i>
                    <input type="tel" id="modal-whatsapp" placeholder="e.g. 0721234567" maxlength="10"
                           class="w-full p-3 pl-10 rounded-lg bg-gray-100 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
                </div>
            </div>
            <div class="form-group">
                <label for="modal-facebook"
                       class="block mb-1 font-bold text-xs uppercase tracking-wider opacity-70">Facebook
                    URL</label>
                <div class="relative">
                    <i class="fa-brands fa-facebook absolute left-3 top-3.5 text-blue-600"></i>
                    <input type="url" id="modal-facebook" maxlength="200"
                           placeholder="https://facebook.com/yourpage"
                           class="w-full p-3 pl-10 rounded-lg bg-gray-100 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
                </div>
            </div>
            <div class="form-group">
                <label for="modal-website"
                       class="block mb-1 font-bold text-xs uppercase tracking-wider opacity-70">Website
                    URL</label>
                <div class="relative">
                    <i class="fa-solid fa-globe absolute left-3 top-3.5 text-gray-500"></i>
                    <input type="url" id="modal-website" maxlength="200"
                           placeholder="https://yourwebsite.com"
                           class="w-full p-3 pl-10 rounded-lg bg-gray-100 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
                </div>
            </div>
        </div>
        <div class="p-6 bg-gray-50 dark:bg-slate-800/50 flex gap-3">
            <button type="button" id="save-social-links"
                    class="flex-1 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition">
                Save Links
            </button>
        </div>
    </div>
</div>

<div id="gallery-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-2xl overflow-hidden shadow-2xl border border-gray-100 dark:border-slate-800">
        <div class="p-6 border-b border-gray-100 dark:border-slate-800 flex justify-between items-center">
            <div>
                <h3 class="text-xl font-bold">Business Gallery</h3>
                <p class="text-xs opacity-50">Upload up to 5 photos (max 1MB each)</p>
            </div>
            <button type="button" id="close-gallery-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white transition">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-2 sm:grid-cols-5 gap-4" id="gallery-grid">
                <!-- 5 Photo Slots -->
            </div>
        </div>
        <div class="p-6 bg-gray-50 dark:bg-slate-800/50 flex justify-end">
            <button type="button" id="save-gallery" class="px-8 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition">
                Done
            </button>
        </div>
    </div>
</div>

<script src="../scripts/theme.js"></script>

<script src="https://unpkg.com/dexie/dist/dexie.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="../scripts/firebase.js"></script>
<script src="../scripts/card-renderer.js"></script>

<script>
    const formContainer = document.getElementById('form-container');
    const formContentWrapper = document.getElementById('form-content-wrapper');
    const formTitle = document.getElementById('form-title');
    const formDescription = document.getElementById('form-description');
    const cancelFormBtn = document.getElementById('cancel-form-btn');
    const newListingBtn = document.getElementById('new-listing-btn');
    const businessForm = document.getElementById('business-form');
    const submitBtn = document.getElementById('submit-btn');
    const submitBtnWrapper = document.getElementById('submit-btn-wrapper');
    const statusContainer = document.getElementById('status-container');
    const pendingStatusContainer = document.getElementById('pending-status-container');

    const ownerNameInput = document.getElementById('owner-name');
    const emailInput = document.getElementById('email');
    const phoneInput = document.getElementById('phone');
    const businessNameInput = document.getElementById('business-name');
    const subHeadingInput = document.getElementById('sub-heading');
    const businessTypeInput = document.getElementById('business-type');
    const addressInput = document.getElementById('address');
    const modalAddressInput = document.getElementById('modal-address');
    const addressModal = document.getElementById('address-modal');
    const closeAddressModalBtn = document.getElementById('close-address-modal');
    const confirmAddressBtn = document.getElementById('confirm-address');
    const websiteInput = document.getElementById('website');
    const whatsappInput = document.getElementById('whatsapp');
    const facebookInput = document.getElementById('facebook');
    const latitudeInput = document.getElementById('latitude');
    const longitudeInput = document.getElementById('longitude');
    const hoursInput = document.getElementById('hours');
    const hoursTypeSelect = document.getElementById('hours-type');
    const selectedHoursContainer = document.getElementById('selected-hours-container');
    const timeScheduleComponent = document.getElementById('time-schedule-component');
    const photosInput = document.getElementById('business-photos');
    const photosSummary = document.getElementById('photos-summary');
    const galleryModal = document.getElementById('gallery-modal');
    const openGalleryBtn = document.getElementById('open-gallery-btn');
    const closeGalleryModalBtn = document.getElementById('close-gallery-modal');
    const saveGalleryBtn = document.getElementById('save-gallery');
    const galleryGrid = document.getElementById('gallery-grid');
    let uploadedPhotos = []; // Array of URLs
    let userCategories = [];

    newListingBtn.addEventListener('click', () => {
        formContentWrapper.classList.remove('hidden');
        applicationsSection.classList.add('hidden');
        newListingBtn.classList.add('hidden');
        cancelFormBtn.classList.remove('hidden');
        formTitle.textContent = 'New Business Listing';
        businessForm.scrollIntoView({ behavior: 'smooth' });
    });

    cancelFormBtn.addEventListener('click', async () => {
        if (currentEditingAppId || businessForm.dataset.changed === 'true') {
            if (!confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
                return;
            }

            // If we were editing a PENDING application, we might need to revert or delete
            if (currentEditingAppId) {
                const app = applications.find(a => a.id === currentEditingAppId);
                const appRef = db.collection('poortjie').doc('applications').collection('listings').doc(currentEditingAppId);

                // Only touch the DB if it's currently in a 'pending' state (meaning it's a submitted update/listing)
                if (app && app.status === 'pending') {
                    try {
                        if (app.businessRef) {
                            // If it has a businessRef and is pending, it's a submitted edit.
                            // Revert to approved and strip draft data.
                            const updateData = {
                                ownerName: firebase.firestore.FieldValue.delete(),
                                email: firebase.firestore.FieldValue.delete(),
                                phone: firebase.firestore.FieldValue.delete(),
                                businessName: firebase.firestore.FieldValue.delete(),
                                subHeading: firebase.firestore.FieldValue.delete(),
                                address: firebase.firestore.FieldValue.delete(),
                                latitude: firebase.firestore.FieldValue.delete(),
                                longitude: firebase.firestore.FieldValue.delete(),
                                website: firebase.firestore.FieldValue.delete(),
                                whatsapp: firebase.firestore.FieldValue.delete(),
                                facebook: firebase.firestore.FieldValue.delete(),
                                hours: firebase.firestore.FieldValue.delete(),
                                description: firebase.firestore.FieldValue.delete(),
                                photos: firebase.firestore.FieldValue.delete(),
                                services: firebase.firestore.FieldValue.delete(),
                                status: 'approved',
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            await appRef.update(updateData);
                        } else {
                            // New application (no businessRef) that was pending, delete it
                            await appRef.delete();
                        }
                    } catch (e) {
                        console.error("Error reverting/deleting application data:", e);
                    }
                }
            }
        }
        location.reload();
    });

    window.cancelPendingApplication = async (appId) => {
        const user = auth.currentUser;
        if (!user || !appId) return;

        if (!confirm('Are you sure you want to cancel your pending application? This action cannot be undone.')) {
            return;
        }

        const btn = document.querySelector(`button[onclick="cancelPendingApplication('${appId}')"]`);
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner animate-spin"></i> Cancelling...';
        }

        try {
            const app = applications.find(a => a.id === appId);
            const appRef = db.collection('poortjie').doc('applications').collection('listings').doc(appId);

            // Only touch the DB if it's currently in a 'pending' state
            if (app && app.status === 'pending') {
                if (app.businessRef) {
                    // If it has a businessRef and is pending, it's a submitted edit. 
                    // Revert to approved and strip draft data.
                    const updateData = {
                        ownerName: firebase.firestore.FieldValue.delete(),
                        email: firebase.firestore.FieldValue.delete(),
                        phone: firebase.firestore.FieldValue.delete(),
                        businessName: firebase.firestore.FieldValue.delete(),
                        subHeading: firebase.firestore.FieldValue.delete(),
                        address: firebase.firestore.FieldValue.delete(),
                        latitude: firebase.firestore.FieldValue.delete(),
                        longitude: firebase.firestore.FieldValue.delete(),
                        website: firebase.firestore.FieldValue.delete(),
                        whatsapp: firebase.firestore.FieldValue.delete(),
                        facebook: firebase.firestore.FieldValue.delete(),
                        hours: firebase.firestore.FieldValue.delete(),
                        description: firebase.firestore.FieldValue.delete(),
                        photos: firebase.firestore.FieldValue.delete(),
                        services: firebase.firestore.FieldValue.delete(),
                        status: 'approved',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await appRef.update(updateData);
                } else {
                    // New application (no businessRef) that was pending, delete it
                    await appRef.delete();
                }
            }
            
            // UI will be updated via onSnapshot, but we also want to refresh the page as requested
            alert('Your application has been cancelled.');
            location.reload();
        } catch (error) {
            console.error("Error cancelling application:", error);
            alert('Failed to cancel application. Please try again.');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-trash-can"></i> Cancel Application';
            }
        }
    };

    const renderPendingApplications = (pendingApplications) => {
        if (!pendingApplications || pendingApplications.length === 0) {
            pendingStatusContainer.innerHTML = '';
            pendingStatusContainer.classList.add('hidden');
            return;
        }

        pendingStatusContainer.classList.remove('hidden');
        pendingStatusContainer.innerHTML = pendingApplications.map(app => `
            <div class="p-6 rounded-2xl bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-100 dark:border-yellow-900/30 text-center lg:text-left">
                <div class="flex flex-col items-center lg:items-start gap-4">
                    <div class="w-12 h-12 rounded-full bg-yellow-100 dark:bg-yellow-900/40 flex items-center justify-center text-yellow-600 dark:text-yellow-400">
                        <i class="fa-solid fa-clock-rotate-left text-xl animate-pulse"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-yellow-800 dark:text-yellow-300">Application Pending</h3>
                        <p class="text-sm text-yellow-700 dark:text-yellow-400 opacity-90 mt-1">
                            Your application for <span class="font-bold">${app.businessName}</span> is currently being reviewed.
                        </p>
                    </div>
                    <button onclick="cancelPendingApplication('${app.id}')" class="px-6 py-2 bg-white dark:bg-slate-800 text-red-600 dark:text-red-400 font-bold rounded-xl border border-red-100 dark:border-red-900/30 hover:bg-red-50 dark:hover:bg-red-900/20 transition flex items-center gap-2 shadow-sm">
                        <i class="fa-solid fa-trash-can"></i>
                        Cancel Application
                    </button>
                </div>
            </div>
        `).join('');
    };

    function resetFormState() {
        formContentWrapper.classList.add('hidden');
        pendingStatusContainer.classList.add('hidden');
        formDescription.classList.remove('hidden');
        if (userCategories.length > 0) {
            applicationsSection.classList.remove('hidden');
            newListingBtn.classList.remove('hidden');
        } else {
            formContentWrapper.classList.remove('hidden');
            applicationsSection.classList.add('hidden');
            newListingBtn.classList.add('hidden');
        }
        cancelFormBtn.classList.add('hidden');
        formTitle.textContent = 'Business Listing';
        currentEditingAppId = null;
        businessForm.reset();
        uploadedPhotos = [];
        updatePhotosSummary();
        servicesList.innerHTML = '';
        delete businessForm.dataset.changed;
        
        // Clear errors
        document.querySelectorAll('p[id$="-error"]').forEach(el => el.classList.add('hidden'));
        
        // Reset description counter
        descCounter.textContent = '0/200';
        
        // Ensure preview reflects reset state
        updatePreview();

        // Re-populate basic info if user is logged in
        const user = auth.currentUser;
        if (user) {
            const userDocRef = db.collection('users').doc(user.uid);
            userDocRef.get().then((userDoc) => {
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    ownerNameInput.value = userData.displayName || user.displayName || '';
                    phoneInput.value = userData.phone || '';
                } else {
                    ownerNameInput.value = user.displayName || '';
                }
                emailInput.value = user.email || '';
            });
        }
    }

    businessTypeInput.addEventListener('change', () => {
        const selectedType = businessTypeInput.value;
        if (selectedType && userCategories.includes(selectedType)) {
            const confirmNew = confirm(`You already have a listing in "${selectedType}". Are you sure you want to create another one? It might be better to edit your existing one.`);
            if (!confirmNew) {
                businessTypeInput.value = '';
                validateForm(false);
                updatePreview();
                return;
            }
        }
        validateForm(false);
        updatePreview();
    });

    const renderGallery = () => {
        galleryGrid.innerHTML = '';
        for (let i = 0; i < 5; i++) {
            const photoUrl = uploadedPhotos[i];
            const slot = document.createElement('div');
            slot.className = 'relative aspect-square rounded-xl border-2 border-dashed border-gray-200 dark:border-slate-700 overflow-hidden group flex items-center justify-center bg-gray-50 dark:bg-slate-800/50';
            
            if (photoUrl) {
                slot.innerHTML = `
                    <img src="${photoUrl}" class="w-full h-full object-cover" alt="">
                    <button type="button" class="remove-photo absolute top-1 right-1 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-lg" data-index="${i}">
                        <i class="fa-solid fa-xmark text-xs"></i>
                    </button>
                `;
                slot.querySelector('.remove-photo').onclick = (e) => {
                    e.stopPropagation();
                    uploadedPhotos.splice(i, 1);
                    renderGallery();
                    updatePhotosSummary();
                };
            } else {
                slot.innerHTML = `
                    <label class="cursor-pointer flex flex-col items-center justify-center w-full h-full hover:bg-gray-100 dark:hover:bg-slate-700 transition">
                        <i class="fa-solid fa-plus text-gray-400"></i>
                        <input type="file" class="hidden photo-upload-input" accept="image/*" data-index="${i}">
                    </label>
                `;
                const fileInput = slot.querySelector('.photo-upload-input');
                fileInput.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    // Show local loader
                    slot.innerHTML = `
                        <div class="flex flex-col items-center gap-2">
                            <div class="animate-spin h-5 w-5 border-2 border-green-500 border-t-transparent rounded-full"></div>
                            <span class="text-[8px] font-bold opacity-50 uppercase">Processing...</span>
                        </div>
                    `;

                    try {
                        const user = auth.currentUser;
                        if (!user) throw new Error("User not authenticated.");

                        // Resize and Crop Image to 1:1 and ensure < 1MB
                        const processImage = (file) => {
                            return new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = (event) => {
                                    const img = new Image();
                                    img.onload = () => {
                                        const canvas = document.createElement('canvas');
                                        let width = img.width;
                                        let height = img.height;

                                        // 1:1 Crop logic
                                        let size = Math.min(width, height);
                                        let xOffset = (width - size) / 2;
                                        let yOffset = (height - size) / 2;

                                        const MAX_DIM = 1200;
                                        let targetSize = Math.min(size, MAX_DIM);

                                        canvas.width = targetSize;
                                        canvas.height = targetSize;
                                        const ctx = canvas.getContext('2d');
                                        ctx.drawImage(img, xOffset, yOffset, size, size, 0, 0, targetSize, targetSize);

                                        let quality = 0.9;
                                        let dataUrl = canvas.toDataURL('image/jpeg', quality);

                                        while (dataUrl.length * 0.75 > 1024 * 1024 && quality > 0.1) {
                                            quality -= 0.1;
                                            dataUrl = canvas.toDataURL('image/jpeg', quality);
                                        }

                                        // Convert dataUrl back to Blob for Firebase Upload
                                        fetch(dataUrl)
                                            .then(res => res.blob())
                                            .then(blob => resolve(blob))
                                            .catch(reject);
                                    };
                                    img.onerror = reject;
                                    img.src = event.target.result;
                                };
                                reader.onerror = reject;
                                reader.readAsDataURL(file);
                            });
                        };

                        const processedBlob = await processImage(file);

                        // Update loader text
                        slot.querySelector('span').textContent = 'Uploading...';

                        const fileName = `${Date.now()}_${i}`;
                        const storageRef = firebase.storage().ref(`business-photos/${user.uid}/${fileName}`);
                        const snapshot = await storageRef.put(processedBlob);
                        const url = await snapshot.ref.getDownloadURL();

                        uploadedPhotos.push(url);
                        renderGallery();
                        updatePhotosSummary();
                    } catch (error) {
                        console.error("Upload failed:", error);
                        let friendlyMsg = 'Upload failed: ' + error.message;

                        // Check for CORS or Network errors
                        const isCorsError = error.message && (
                            error.message.includes('CORS') ||
                            error.message.includes('preflight') ||
                            error.message.includes('access control check')
                        );

                        if (location.protocol === 'file:') {
                            friendlyMsg = 'Photo upload is not supported when opening the file directly (file://). Please host the website or use a local server.';
                        } else if (isCorsError) {
                            friendlyMsg = 'Upload blocked by CORS policy. Please ensure your Firebase Storage bucket is configured to allow requests from ' + window.location.origin + '.';
                        } else if (error.code === 'storage/unauthorized') {
                            friendlyMsg = 'You do not have permission to upload photos. Please try logging out and back in.';
                        } else if (error.code === 'storage/retry-limit-exceeded') {
                            friendlyMsg = 'Upload took too long. Please check your internet connection.';
                        }
                        alert(friendlyMsg);
                        renderGallery();
                    }
                };
            }
            galleryGrid.appendChild(slot);
        }
    };

    const updatePhotosSummary = () => {
        photosInput.value = JSON.stringify(uploadedPhotos);
        if (uploadedPhotos.length === 0) {
            photosSummary.innerHTML = '<p class="text-xs opacity-50 italic py-2">No photos added yet (max 5).</p>';
        } else {
            photosSummary.innerHTML = uploadedPhotos.map((url, i) => `
                <div class="relative w-12 h-12 rounded-lg overflow-hidden border border-gray-100 dark:border-slate-800 shrink-0 shadow-sm">
                    <img src="${url}" class="w-full h-full object-cover" alt="">
                </div>
            `).join('');
        }
        validateForm(false);
        updatePreview();
    };

    openGalleryBtn.addEventListener('click', () => {
        galleryModal.classList.remove('hidden');
        renderGallery();
    });

    closeGalleryModalBtn.addEventListener('click', () => galleryModal.classList.add('hidden'));
    saveGalleryBtn.addEventListener('click', () => galleryModal.classList.add('hidden'));

    const updateHoursDisplay = () => {
        const type = hoursTypeSelect.value;
        selectedHoursContainer.classList.add('hidden');
        hoursInput.classList.add('hidden');

        if (type === 'always') {
            hoursInput.value = 'Always Open';
        } else if (type === 'appointment') {
            hoursInput.value = 'By Appointment Only';
        } else if (type === 'selected') {
            selectedHoursContainer.classList.remove('hidden');
            
            if (timeScheduleComponent && typeof timeScheduleComponent.getScheduleData === 'function') {
                const scheduleData = timeScheduleComponent.getScheduleData();
                if (scheduleData && scheduleData.length > 0) {
                    const schedule = scheduleData.map(day => {
                        const shortDay = day.day.substring(0, 3);
                        if (day.status === 'closed') return `${shortDay} Closed`;
                        return `${shortDay} ${day.openingTime}-${day.closingTime}`;
                    });
                    hoursInput.value = schedule.join(', ');
                }
            }
        } else if (type === 'custom') {
            hoursInput.classList.remove('hidden');
        }
        
        // Dispatch input event so listeners on hoursInput (like updatePreview) are triggered
        hoursInput.dispatchEvent(new Event('input', { bubbles: true }));
        validateForm(false);
    };

    hoursTypeSelect.addEventListener('change', updateHoursDisplay);
    if (timeScheduleComponent) {
        timeScheduleComponent.addEventListener('change', () => {
            updateHoursDisplay();
        });
    }

    const descInput = document.getElementById('description');
    const descCounter = document.getElementById('description-counter');
    const servicesList = document.getElementById('services-list');
    const addServiceBtn = document.getElementById('add-service-btn');
    const previewContainer = document.getElementById('preview-container');
    const cardPreview = document.getElementById('card-preview');
    const applicationsSection = document.getElementById('applications-section');
    const userApplicationsList = document.getElementById('user-applications-list');

    let currentEditingAppId = null;
    let originalAppData = null;
    let applications = [];

    addressInput.addEventListener('click', () => {
        addressModal.classList.remove('hidden');
        modalAddressInput.value = addressInput.value === 'Poortjie' ? '' : addressInput.value;
        if (!map) {
            initMap();
        } else {
            google.maps.event.trigger(map, 'resize');
            if (selectedLat && selectedLng) {
                const pos = {lat: selectedLat, lng: selectedLng};
                map.setCenter(pos);
                marker.setPosition(pos);
            } else {
                const poortjieCenter = {lat: -26.456323807221267, lng: 27.77044633885547};
                map.setCenter(poortjieCenter);
                marker.setPosition(poortjieCenter);
            }
        }
    });

    closeAddressModalBtn.addEventListener('click', () => {
        addressModal.classList.add('hidden');
    });

    confirmAddressBtn.addEventListener('click', () => {
        if (modalAddressInput.value.trim()) {
            addressInput.value = modalAddressInput.value.trim();
        } else {
            addressInput.value = 'Poortjie';
        }
        addressModal.classList.add('hidden');
        validateForm();
        updatePreview();
    });

    const socialModal = document.getElementById('social-modal');
    const openSocialModalBtn = document.getElementById('open-social-modal');
    const closeSocialModalBtn = document.getElementById('close-social-modal');
    const saveSocialLinksBtn = document.getElementById('save-social-links');
    const socialLinksSummary = document.getElementById('social-links-summary');

    const modalWhatsapp = document.getElementById('modal-whatsapp');
    const modalFacebook = document.getElementById('modal-facebook');
    const modalWebsite = document.getElementById('modal-website');
    let map, marker, geocoder;
    let selectedLat = null;
    let selectedLng = null;

    const addServiceRow = (name = '', price = '') => {
        const row = document.createElement('div');
        row.className = 'flex flex-wrap sm:flex-nowrap gap-2 items-center animate-fadeIn p-3 bg-gray-50 dark:bg-slate-800/30 rounded-xl border border-gray-100 dark:border-slate-700/50';
        row.innerHTML = `
            <input type="text" placeholder="Service name" value="${name}" class="service-name-input flex-1 min-w-[150px] p-2 text-sm rounded-lg bg-white dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
            <div class="flex items-center gap-2 w-full sm:w-auto">
                <div class="relative flex-1 sm:w-28">
                    <span class="absolute left-2 top-1/2 -translate-y-1/2 text-xs opacity-50">R</span>
                    <input type="text" placeholder="Price" value="${price.replace('R', '')}" class="service-price-input w-full p-2 pl-5 text-sm rounded-lg bg-white dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
                </div>
                <button type="button" class="remove-service-btn text-red-500 p-2 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition shrink-0">
                    <i class="fas fa-trash-can"></i>
                </button>
            </div>
        `;
        servicesList.appendChild(row);

        const priceInput = row.querySelector('.service-price-input');
        priceInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9.]/g, '');
            validateForm(false);
        });

        row.querySelector('.remove-service-btn').addEventListener('click', () => {
            row.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                row.remove();
                validateForm(false);
            }, 200);
        });

        row.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', () => validateForm(false));
        });
    };

    addServiceBtn.addEventListener('click', () => addServiceRow());

    const getServicesData = () => {
        const rows = servicesList.children;
        const services = [];
        Array.from(rows).forEach(row => {
            const nameInput = row.querySelector('.service-name-input');
            const priceInput = row.querySelector('.service-price-input');
            if (nameInput) {
                const name = nameInput.value.trim();
                const price = priceInput.value.trim();
                if (name) {
                    services.push({ name, price: price ? 'R' + price : '' });
                }
            }
        });
        return services;
    };

    let isAddressSelectedFromAutocomplete = false;

    showLoader();

    const fetchCategories = () => {
        const servicesDocRef = db.collection('poortjie').doc('services');
        servicesDocRef.get().then(doc => {
            if (doc.exists) {
                const homeScreenData = doc.data().homeScreen;
                if (homeScreenData && typeof homeScreenData === 'object') {
                    const categories = Object.keys(homeScreenData);

                    renderCategoryOptions(categories);
                }
            }
        }).catch(error => {
        }).finally(() => {
            if (!Array.from(businessTypeInput.options).some(opt => opt.value === 'Other')) {
                const otherOption = document.createElement('option');
                otherOption.value = 'Other';
                otherOption.textContent = 'Other';
                businessTypeInput.appendChild(otherOption);
            }
        });
    };

    const renderCategoryOptions = (categories) => {
        while (businessTypeInput.options.length > 1) {
            businessTypeInput.remove(1);
        }

        const sortedCategories = [...categories].sort((a, b) => a.localeCompare(b));

        sortedCategories.forEach(categoryName => {
            const option = document.createElement('option');
            option.value = categoryName;
            option.textContent = categoryName;
            businessTypeInput.appendChild(option);
        });
    };

    const getStatusBadge = (status) => {
        switch (status) {
            case 'approved':
                return `<span class="text-[10px] font-bold py-1 px-2 uppercase rounded-full text-green-700 bg-green-100 border border-green-200">Approved</span>`;
            case 'rejected':
                return `<span class="text-[10px] font-bold py-1 px-2 uppercase rounded-full text-red-700 bg-red-100 border border-red-200">Rejected</span>`;
            case 'update':
                return `<span class="text-[10px] font-bold py-1 px-2 uppercase rounded-full text-blue-700 bg-blue-100 border border-blue-200">Update</span>`;
            default:
                return `<span class="text-[10px] font-bold py-1 px-2 uppercase rounded-full text-yellow-700 bg-yellow-100 border border-yellow-200">Pending</span>`;
        }
    };

    const renderUserApplications = async (applications) => {
        // userCategories is used to prevent duplicate listings in same category
        userCategories = applications
            .map(app => app.businessType);

        if (!applications || applications.length === 0) {
            applicationsSection.classList.add('hidden');
            formContentWrapper.classList.remove('hidden');
            businessForm.classList.remove('hidden');
            formDescription.classList.remove('hidden');
            newListingBtn.classList.add('hidden');
            return;
        }

        applicationsSection.classList.remove('hidden');
        
        // Check if there are any active applications
        const hasActiveApplications = applications.some(app => app.status !== 'pending');
        const hasPending = applications.some(app => app.status === 'pending');

        if (hasActiveApplications || hasPending) {
            formContentWrapper.classList.add('hidden');
        } else {
            formContentWrapper.classList.remove('hidden');
            businessForm.classList.remove('hidden');
            formDescription.classList.remove('hidden');
        }

        newListingBtn.classList.remove('hidden');
        const applicationItems = await Promise.all(applications.map(async (app) => {
            const isRejected = app.status === 'rejected';
            const canEdit = (app.status === 'approved' || app.status === 'update') && !isRejected;
            
            let displayData = { ...app };
            if (app.businessRef && app.status === 'approved') {
                try {
                    const docSnap = await db.doc(app.businessRef).get();
                    if (docSnap.exists) {
                        displayData = { ...app, ...docSnap.data() };
                    }
                } catch (e) {
                    console.error("Error fetching display name:", e);
                }
            }

            return `
                <div class="p-4 rounded-xl bg-gray-50 dark:bg-slate-800/50 border border-gray-100 dark:border-slate-700 flex justify-between items-center">
                    <div>
                        <h4 class="font-bold text-sm">${displayData.businessName}</h4>
                        <p class="text-xs opacity-60">${displayData.businessType}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        ${getStatusBadge(app.status)}
                        ${canEdit ? `
                            <button onclick="editApplication('${app.id}')" class="text-xs font-bold text-green-600 hover:text-green-700 dark:text-green-500 dark:hover:text-green-400 flex items-center gap-1">
                                <i class="fa-solid fa-pen-to-square"></i> Edit
                            </button>
                        ` : ''}
                        ${isRejected ? `
                            <button onclick="removeApplication('${app.id}')" class="text-xs font-bold text-red-600 hover:text-red-700 dark:text-red-500 dark:hover:text-red-400 flex items-center gap-1">
                                <i class="fa-solid fa-trash-can"></i> Remove
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }));
        userApplicationsList.innerHTML = applicationItems.join('');

        window.removeApplication = async (appId) => {
            if (!confirm('Are you sure you want to remove this rejected application? This cannot be undone.')) {
                return;
            }

            try {
                await db.collection('poortjie').doc('applications').collection('listings').doc(appId).delete();
                alert('Application removed.');
                // UI will refresh via onSnapshot or manual reload
                location.reload();
            } catch (error) {
                console.error("Error removing application:", error);
                alert('Failed to remove application: ' + error.message);
            }
        };

        window.editApplication = async (appId) => {
            const app = applications.find(a => a.id === appId);
            if (!app) return;

            let displayData = app;
            if (app.businessRef && (!app.businessName || app.status === 'approved')) {
                // Pull data from services if it's not in application (or if it's approved and we want the latest public data)
                try {
                    const docRef = db.doc(app.businessRef);
                    const docSnap = await docRef.get();
                    if (docSnap.exists) {
                        displayData = { ...app, ...docSnap.data(), id: appId };
                    }
                } catch (e) {
                    console.error("Error pulling data from businessRef:", e);
                }
            }

            currentEditingAppId = appId;
            originalAppData = JSON.parse(JSON.stringify(displayData)); // Deep copy to store original state

            formContentWrapper.classList.remove('hidden');
            applicationsSection.classList.add('hidden');
            newListingBtn.classList.add('hidden');
            cancelFormBtn.classList.remove('hidden');
            formTitle.textContent = `Editing: ${displayData.businessName}`;
            businessForm.scrollIntoView({ behavior: 'smooth' });

            // Populate form
            ownerNameInput.value = displayData.ownerName || '';
            emailInput.value = displayData.email || '';
            phoneInput.value = displayData.phone || '';
            businessNameInput.value = displayData.businessName;
            subHeadingInput.value = displayData.subHeading || '';
            businessTypeInput.value = displayData.businessType || '';
            addressInput.value = displayData.address || '';
            websiteInput.value = displayData.website || '';
            whatsappInput.value = displayData.whatsapp || '';
            facebookInput.value = displayData.facebook || '';
            hoursInput.value = displayData.hours || '';

            // Handle photos population
            uploadedPhotos = displayData.photos || [];
            updatePhotosSummary();

            // Handle hours population
            if (displayData.hours === 'Always Open') {
                hoursTypeSelect.value = 'always';
            } else if (displayData.hours === 'By Appointment Only') {
                hoursTypeSelect.value = 'appointment';
            } else if (displayData.hours && (displayData.hours.includes('Mon ') || displayData.hours.includes('Tue ') || displayData.hours.includes('Wed ') || displayData.hours.includes('Thu ') || displayData.hours.includes('Fri ') || displayData.hours.includes('Sat ') || displayData.hours.includes('Sun ') || displayData.hours.includes('Mon-Fri '))) {
                hoursTypeSelect.value = 'selected';
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
                // Try to match Mon-Fri combined format first
                const weekMatch = displayData.hours.match(/Mon-Fri (\d{2}:\d{2})-(\d{2}:\d{2})/);
            
                const scheduleData = days.map(day => {
                    const shortDay = day.substring(0, 3);
                    const regex = new RegExp(`${shortDay} (\\d{2}:\\d{2})-(\\d{2}:\\d{2})`);
                    const match = displayData.hours.match(regex);
                    if (match) {
                        return { day, status: 'open', openingTime: match[1], closingTime: match[2] };
                    } else if (['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].includes(day) && weekMatch) {
                        return { day, status: 'open', openingTime: weekMatch[1], closingTime: weekMatch[2] };
                    } else {
                        const isClosed = displayData.hours.includes(`${shortDay} Closed`);
                        return { day, status: isClosed ? 'closed' : 'open', openingTime: '08:00', closingTime: '17:00' };
                    }
                });
                if (timeScheduleComponent && typeof timeScheduleComponent.setScheduleData === 'function') {
                    timeScheduleComponent.setScheduleData(scheduleData);
                }
            } else if (displayData.hours) {
                hoursTypeSelect.value = 'custom';
            }
            updateHoursDisplay();

            descInput.value = displayData.description || '';
            const count = descInput.value.length;
            descCounter.textContent = `${count}/200`;

            // Populate services
            servicesList.innerHTML = '';
            if (displayData.services && Array.isArray(displayData.services)) {
                displayData.services.forEach(s => addServiceRow(s.name, s.price));
            }

            selectedLat = displayData.latitude || null;
            selectedLng = displayData.longitude || null;
            latitudeInput.value = selectedLat;
            longitudeInput.value = selectedLng;
            isAddressSelectedFromAutocomplete = !!displayData.address;

            // Update social links summary
            const links = [];
            if (displayData.whatsapp) links.push('WhatsApp');
            if (displayData.facebook) links.push('Facebook');
            if (displayData.website) links.push('Website');
            if (links.length > 0) {
                socialLinksSummary.textContent = links.join(', ');
                socialLinksSummary.classList.remove('opacity-70');
                socialLinksSummary.classList.add('text-green-600', 'font-bold');
            } else {
                socialLinksSummary.textContent = 'Add WhatsApp, Facebook, Website';
                socialLinksSummary.classList.add('opacity-70');
                socialLinksSummary.classList.remove('text-green-600', 'font-bold');
            }

            // Make sure fields are editable in case they were locked by a pending app before
            businessForm.querySelectorAll('input, textarea, select').forEach(el => {
                if (!['owner-name', 'email'].includes(el.id)) {
                    el.disabled = false;
                }
            });
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            submitBtn.style.pointerEvents = 'auto';
            submitBtn.textContent = 'Submit Listing';

            // Update character counter
            const countVal = descInput.value.length;
            descCounter.textContent = `${countVal}/200`;

            // Clear previous error messages if any
            document.querySelectorAll('p[id$="-error"]').forEach(el => el.classList.add('hidden'));

            // Unlock form fields
            businessForm.querySelectorAll('input, textarea, select').forEach(el => {
                if (el.id !== 'owner-name' && el.id !== 'email') {
                    el.disabled = false;
                }
            });
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            submitBtn.style.pointerEvents = 'auto';
            submitBtn.textContent = 'Update Business Details';

            // Update form description
            const formDesc = document.querySelector('#form-container p');
            if (formDesc) {
                formDesc.textContent = 'Update your business details below.';
                formDesc.classList.remove('text-yellow-600', 'dark:text-yellow-400', 'text-blue-600', 'dark:text-blue-400', 'text-red-600', 'dark:text-red-400', 'font-bold');
                formDesc.classList.add('opacity-70');
            }

            // Show form if it was hidden
            businessForm.classList.remove('hidden');
            statusContainer.classList.add('hidden');

            window.scrollTo({top: businessForm.offsetTop - 100, behavior: 'smooth'});
            validateForm();
        };
    };

    const lockForm = (data) => {
        businessForm.querySelectorAll('input, textarea, select').forEach(el => el.disabled = true);
        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        submitBtn.style.pointerEvents = 'none'; // Truly disable for locked forms
        submitBtn.textContent = 'Application Pending';
        if (data.status === 'update') {
            formDescription.textContent = 'An update has been requested for your application. Please click "Edit" below to make changes.';
            formDescription.classList.add('text-blue-600', 'dark:text-blue-400', 'font-bold');
            formDescription.classList.remove('opacity-70');
        } else if (data.status === 'rejected') {
            formDescription.textContent = 'Your application was rejected. You can remove it and start a new one if you wish.';
            formDescription.classList.add('text-red-600', 'dark:text-red-400', 'font-bold');
            formDescription.classList.remove('opacity-70');
        }
    };

    const validateForm = (showErrors = false) => {
        const isNameValid = ownerNameInput.value.trim().length > 0;
        const isEmailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value.trim());
        const isPhoneValid = /^\d{10}$/.test(phoneInput.value.trim());
        const isBusinessNameValid = businessNameInput.value.trim().length > 0;
        const isBusinessTypeValid = businessTypeInput.value !== '';
        const isDescValid = descInput.value.trim().length > 0;

        const addressValue = addressInput.value.trim();
        let isAddressValid = addressValue.length > 0;
        // If address is something other than 'Poortjie', we might want to check for coordinates
        if (addressValue !== 'Poortjie' && addressValue !== '') {
            isAddressValid = selectedLat !== null && selectedLng !== null;
        }

        const isValid = isNameValid && isEmailValid && isPhoneValid && isBusinessNameValid && isDescValid && isBusinessTypeValid && isAddressValid;

        let hasChanges = true;
        if (currentEditingAppId && originalAppData) {
            const currentData = {
                phone: phoneInput.value.trim(),
                businessName: businessNameInput.value.trim(),
                subHeading: subHeadingInput.value.trim(),
                businessType: businessTypeInput.value,
                address: addressInput.value.trim() || null,
                latitude: latitudeInput.value ? parseFloat(latitudeInput.value) : null,
                longitude: longitudeInput.value ? parseFloat(longitudeInput.value) : null,
                website: websiteInput.value.trim() || null,
                whatsapp: whatsappInput.value.trim() || null,
                facebook: facebookInput.value.trim() || null,
                hours: hoursInput.value.trim(),
                description: descInput.value.trim()
            };

            const fieldsToCompare = [
                'phone', 'businessName', 'subHeading', 'businessType', 'address',
                'latitude', 'longitude', 'website', 'whatsapp', 'facebook', 'hours', 'description', 'services', 'photos'
            ];

            hasChanges = fieldsToCompare.some(field => {
                if (field === 'services') {
                    const currentServices = getServicesData();
                    const originalServices = originalAppData.services || [];
                    if (currentServices.length !== originalServices.length) return true;
                    return currentServices.some((s, i) => 
                        s.name !== originalServices[i].name || s.price !== originalServices[i].price
                    );
                }
                
                if (field === 'photos') {
                    const currentPhotos = uploadedPhotos;
                    const originalPhotos = originalAppData.photos || [];
                    if (currentPhotos.length !== originalPhotos.length) return true;
                    return currentPhotos.some((p, i) => p !== originalPhotos[i]);
                }
                
                let originalVal = originalAppData[field] === undefined ? null : originalAppData[field];
                let currentVal = currentData[field] === undefined ? null : currentData[field];

                // Normalize values for comparison
                const normalize = (val) => {
                    if (val === null || val === undefined) return '';
                    return val.toString().trim().replace(/\s+/g, ' ');
                };

                return normalize(originalVal) !== normalize(currentVal);
            });
        }

        if (isValid && hasChanges) {
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            submitBtn.style.pointerEvents = 'auto';
            if (currentEditingAppId) {
                submitBtn.title = "";
            }
        } else {
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            submitBtn.style.pointerEvents = 'auto'; // Keep it clickable to show errors
            if (currentEditingAppId && isValid && !hasChanges) {
                submitBtn.title = "No changes detected";
            } else {
                submitBtn.title = "";
            }
        }

        if (showErrors) {
            document.getElementById('owner-name-error').classList.toggle('hidden', isNameValid);
            document.getElementById('email-error').classList.toggle('hidden', isEmailValid);
            document.getElementById('phone-error').classList.toggle('hidden', isPhoneValid);
            document.getElementById('business-name-error').classList.toggle('hidden', isBusinessNameValid);
            document.getElementById('business-type-error').classList.toggle('hidden', isBusinessTypeValid);
            document.getElementById('description-error').classList.toggle('hidden', isDescValid);

            const addressError = document.getElementById('address-error');
            if (addressValue.length > 0 && !isAddressValid) {
                addressError.classList.remove('hidden');
            } else {
                addressError.classList.add('hidden');
            }
        } else {
            // Hide errors if they become valid while typing
            if (isNameValid) document.getElementById('owner-name-error').classList.add('hidden');
            if (isEmailValid) document.getElementById('email-error').classList.add('hidden');
            if (isPhoneValid) document.getElementById('phone-error').classList.add('hidden');
            if (isBusinessNameValid) document.getElementById('business-name-error').classList.add('hidden');
            if (isBusinessTypeValid) document.getElementById('business-type-error').classList.add('hidden');
            if (isDescValid) document.getElementById('description-error').classList.add('hidden');
            if (isAddressValid) document.getElementById('address-error').classList.add('hidden');
        }

        updatePreview();
        return isValid && hasChanges;
    };

    const updatePreview = async () => {
        const businessName = businessNameInput.value.trim();
        const description = descInput.value.trim();
        const phone = phoneInput.value.trim();
        const address = addressInput.value.trim();
        const businessType = businessTypeInput.value;

        const website = websiteInput.value.trim();
        const whatsapp = whatsappInput.value.trim();
        const facebook = facebookInput.value.trim();
        const services = getServicesData();
        const hours = hoursInput.value.trim();
        const photos = uploadedPhotos;

        const hasAnyData = businessName || description || phone || services.length > 0 || hours || (hoursTypeSelect && hoursTypeSelect.value) || photos.length > 0;

        if (hasAnyData) {
            if (window.innerWidth >= 1024) {
                formContainer.classList.remove('lg:grid-cols-1', 'max-w-xl', 'mx-auto');
                formContainer.classList.add('lg:grid-cols-2');
            }
            previewContainer.classList.remove('hidden');

            const mockProvider = {
                id: 'preview',
                businessName: businessName,
                subHeading: subHeadingInput.value.trim() || 'Your Tagline',
                description: description || 'Your business description will appear here...',
                phone: phone || '000 000 0000',
                address: address,
                latitude: selectedLat,
                longitude: selectedLng,
                website: website,
                whatsapp: whatsapp,
                facebook: facebook,
                services: services,
                hours: hours,
                photos: photos,
                rating: 5.0,
                ratings: {
                    'preview-user': {
                        rating: 5,
                        comment: 'This is a preview of how your customer comments will look.',
                        timestamp: {toMillis: () => Date.now()},
                        likes: {'user1': true, 'user2': true}
                    }
                }
            };

            const card = await renderServiceCard(mockProvider, businessType || 'Category');
            if (card) {
                cardPreview.innerHTML = '';
                const rateBtn = card.querySelector('.rate-service');
                if (rateBtn) {
                    rateBtn.disabled = true;
                    rateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                cardPreview.appendChild(card);
            }
        } else {
            if (window.innerWidth >= 1024) {
                formContainer.classList.remove('lg:grid-cols-2');
                formContainer.classList.add('lg:grid-cols-1', 'max-w-xl', 'mx-auto');
            }
            previewContainer.classList.add('hidden');
        }
    };

    [ownerNameInput, emailInput, phoneInput, businessNameInput, businessTypeInput, subHeadingInput, hoursInput, descInput, hoursTypeSelect].forEach(el => {
        el.addEventListener('input', () => {
            if (el === descInput) {
                const count = descInput.value.length;
                descCounter.textContent = `${count}/200`;
                descCounter.classList.toggle('text-red-500', count >= 200);
                descCounter.classList.toggle('opacity-40', count < 200);
            }
            validateForm(false);
        });
    });

    openSocialModalBtn.addEventListener('click', () => {
        socialModal.classList.remove('hidden');
        modalWhatsapp.value = whatsappInput.value;
        modalFacebook.value = facebookInput.value;
        modalWebsite.value = websiteInput.value;
    });

    closeSocialModalBtn.addEventListener('click', () => {
        socialModal.classList.add('hidden');
    });

    saveSocialLinksBtn.addEventListener('click', () => {
        whatsappInput.value = modalWhatsapp.value;
        facebookInput.value = modalFacebook.value;
        websiteInput.value = modalWebsite.value;

        const links = [];
        if (whatsappInput.value) links.push('WhatsApp');
        if (facebookInput.value) links.push('Facebook');
        if (websiteInput.value) links.push('Website');

        if (links.length > 0) {
            socialLinksSummary.textContent = links.join(', ');
            socialLinksSummary.classList.remove('opacity-70');
            socialLinksSummary.classList.add('text-green-600', 'font-bold');
        } else {
            socialLinksSummary.textContent = 'Add WhatsApp, Facebook, Website';
            socialLinksSummary.classList.add('opacity-70');
            socialLinksSummary.classList.remove('text-green-600', 'font-bold');
        }

        socialModal.classList.add('hidden');
        validateForm();
    });

    phoneInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0, 10);
        validateForm(false);
    });

    [businessNameInput, subHeadingInput, hoursInput, descInput, hoursTypeSelect].forEach(input => {
        input.addEventListener('input', () => {
            validateForm(false);
            updatePreview();
        });
    });


    modalAddressInput.addEventListener('input', () => {
        isAddressSelectedFromAutocomplete = false;
        selectedLat = null;
        selectedLng = null;
        latitudeInput.value = null;
        longitudeInput.value = null;
    });

    auth.onAuthStateChanged(user => {
        const photosSection = document.getElementById('photos-section');
        if (user) {
            if (photosSection) photosSection.classList.remove('hidden');
            fetchCategories();
            const applicationsRef = db.collection('poortjie').doc('applications').collection('listings').where('userId', '==', user.uid).orderBy('createdAt', 'desc');
            applicationsRef.onSnapshot(snapshot => {
                applications = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderUserApplications(applications);

                    const pendingApplications = applications.filter(app => app.status === 'pending');
                    if (pendingApplications.length > 0) {
                        lockForm(pendingApplications[0]); // Lock with the first one found for defaults
                        formContentWrapper.classList.remove('hidden');
                        businessForm.classList.add('hidden'); // Hide the actual form
                        formDescription.classList.add('hidden'); // Hide default description
                        
                        // Show all pending statuses
                        renderPendingApplications(pendingApplications);
                        
                        newListingBtn.classList.add('hidden');
                        cancelFormBtn.classList.add('hidden'); // Cannot cancel locked form via normal cancel
                        formTitle.textContent = 'Application Pending';

                        // Initial character count for description (even if locked)
                        const count = descInput.value.length;
                        descCounter.textContent = `${count}/200`;

                        updateHoursDisplay();

                        hideLoader();
                        formContainer.classList.remove('hidden');
                        formContainer.classList.add('block', 'lg:grid');
                    } else {
                        // Reset if no pending application (might have been cancelled)
                        businessForm.classList.remove('hidden');
                        pendingStatusContainer.classList.add('hidden');
                        formDescription.classList.remove('hidden');
                    const userDocRef = db.collection('users').doc(user.uid);
                    userDocRef.get().then((userDoc) => {
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            ownerNameInput.value = userData.displayName || user.displayName || '';
                            phoneInput.value = userData.phone || '';
                        } else {
                            ownerNameInput.value = user.displayName || '';
                        }
                        emailInput.value = user.email || '';
                        
                        // Check for saved form data
                        const savedData = sessionStorage.getItem('businessFormDraft');
                        if (savedData) {
                            try {
                                const data = JSON.parse(savedData);
                                businessNameInput.value = data.businessName;
                                subHeadingInput.value = data.subHeading || '';
                                businessTypeInput.value = data.businessType || '';
                                phoneInput.value = data.phone || phoneInput.value;
                                addressInput.value = data.address || '';
                                latitudeInput.value = data.latitude || '';
                                longitudeInput.value = data.longitude || '';
                                websiteInput.value = data.website || '';
                                whatsappInput.value = data.whatsapp || '';
                                facebookInput.value = data.facebook || '';
                                hoursInput.value = data.hours || '';
                                descInput.value = data.description || '';
                                
                                if (data.services) {
                                    // Clear existing and add saved services
                                    servicesContainer.innerHTML = '';
                                    data.services.forEach(s => addService(s.name, s.description));
                                }
                                
                                sessionStorage.removeItem('businessFormDraft');
                                validateForm();
                                updatePreview();
                            } catch (e) {
                                console.error("Error restoring draft:", e);
                            }
                        }
                        
                    }).finally(() => {
                        hideLoader();
                        formContainer.classList.remove('hidden');
                        formContainer.classList.add('block', 'lg:grid');

                        // Initial character count for description
                        const count = descInput.value.length;
                        descCounter.textContent = `${count}/200`;

                        validateForm();
                        updateHoursDisplay();
                    });
                }
            }, (error) => {
                console.error("Error with applications listener:", error);
                hideLoader();
                formContainer.classList.remove('hidden');
                formContainer.classList.add('block', 'lg:grid');
            });
        } else {
            // User not logged in - allow form but with limited data
            if (photosSection) photosSection.classList.add('hidden');
            fetchCategories();
            hideLoader();
            formContainer.classList.remove('hidden');
            formContainer.classList.add('block', 'lg:grid');
            
            // Clear owner/email since we don't know who this is
            ownerNameInput.value = '';
            emailInput.value = '';
            
            // Allow editing these for guest (though they are readonly by default)
            ownerNameInput.readOnly = false;
            ownerNameInput.removeAttribute('readonly');
            ownerNameInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
            ownerNameInput.classList.add('bg-gray-200');
            
            emailInput.readOnly = false;
            emailInput.removeAttribute('readonly');
            emailInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
            emailInput.classList.add('bg-gray-200');

            // Initial character count for description
            const count = descInput.value.length;
            descCounter.textContent = `${count}/200`;
            
            validateForm();
            updateHoursDisplay();
        }
    });

    businessForm.addEventListener('input', () => {
        businessForm.dataset.changed = 'true';
    });

    businessForm.addEventListener('submit', event => {
        event.preventDefault();

        if (!validateForm(true)) {
            // Scroll to first error
            const firstError = document.querySelector('p[id$="-error"]:not(.hidden)');
            if (firstError) {
                firstError.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }

        const user = auth.currentUser;
        if (!user) {
            // Show login required modal
            const loginModal = document.getElementById('login-modal');
            const closeBtn = document.getElementById('close-login-modal');
            const loginBtn = document.getElementById('login-modal-btn');

            loginModal.classList.remove('hidden');

            closeBtn.onclick = () => loginModal.classList.add('hidden');
            loginBtn.onclick = () => {
                const businessData = {
                    businessName: businessNameInput.value,
                    subHeading: subHeadingInput.value,
                    businessType: businessTypeInput.value,
                    phone: phoneInput.value,
                    address: addressInput.value.trim() || null,
                    latitude: latitudeInput.value ? parseFloat(latitudeInput.value) : null,
                    longitude: longitudeInput.value ? parseFloat(longitudeInput.value) : null,
                    website: websiteInput.value,
                    whatsapp: whatsappInput.value,
                    facebook: facebookInput.value,
                    services: getServicesData(),
                    hours: hoursInput.value,
                    description: descInput.value
                };
                sessionStorage.setItem('businessFormDraft', JSON.stringify(businessData));
                sessionStorage.setItem('redirectUrl', window.location.href);
                window.top.location.replace('../authentication/login.html');
            };
            return;
        }

        const originalBtnText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<span class="flex items-center justify-center gap-2">
            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Submitting...
        </span>`;

        const businessData = {
            userId: user.uid,
            userEmail: user.email,
            ownerName: ownerNameInput.value,
            email: emailInput.value,
            phone: phoneInput.value,
            businessName: businessNameInput.value,
            subHeading: subHeadingInput.value,
            businessType: businessTypeInput.value,
            address: addressInput.value.trim() || null,
            latitude: latitudeInput.value ? parseFloat(latitudeInput.value) : null,
            longitude: longitudeInput.value ? parseFloat(longitudeInput.value) : null,
            website: websiteInput.value,
            whatsapp: whatsappInput.value,
            facebook: facebookInput.value,
            services: getServicesData(),
            hours: hoursInput.value,
            photos: uploadedPhotos,
            description: descInput.value,
            status: 'pending',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (!currentEditingAppId) {
            businessData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        }

        const appPromise = currentEditingAppId
            ? db.collection('poortjie').doc('applications').collection('listings').doc(currentEditingAppId).update(businessData)
            : db.collection('poortjie').doc('applications').collection('listings').add(businessData);

        appPromise.then(() => {
            const isUpdate = !!currentEditingAppId;
            currentEditingAppId = null; // Reset after successful submission
            statusContainer.innerHTML = `
                    <div class="p-4 rounded-lg bg-green-100 text-green-700 font-bold border border-green-200">
                        Success! Your business application has been ${isUpdate ? 'updated' : 'submitted'} and is now pending review.
                    </div>
                `;
            statusContainer.classList.remove('hidden');
            businessForm.classList.add('hidden');
            window.scrollTo({top: 0, behavior: 'smooth'});

            setTimeout(() => window.location.reload(), 3000);
        })
            .catch((error) => {
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;

                statusContainer.innerHTML = `
                    <div class="p-4 rounded-lg bg-red-100 text-red-700 font-bold border border-red-200">
                        Error: ${error.message || 'There was an error submitting your form. Please try again.'}
                    </div>
                `;
                statusContainer.classList.remove('hidden');
                window.scrollTo({top: 0, behavior: 'smooth'});
            });
    });


    function initMap() {
        const poortjieCenter = {lat: -26.456323807221267, lng: 27.77044633885547};
        geocoder = new google.maps.Geocoder();

        map = new google.maps.Map(document.getElementById("map"), {
            center: poortjieCenter,
            zoom: 14,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
            styles: [
                {
                    "featureType": "poi",
                    "stylers": [{"visibility": "off"}]
                }
            ]
        });

        // Hide address error if user interacts with map
        google.maps.event.addListener(map, 'click', () => {
            document.getElementById('address-error').classList.add('hidden');
        });
        new google.maps.Circle({
            strokeColor: "#22c55e",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#22c55e",
            fillOpacity: 0.1,
            map: map,
            center: poortjieCenter,
            radius: 5000,
            clickable: false
        });
        marker = new google.maps.Marker({
            position: poortjieCenter,
            map: map,
            draggable: true,
            title: "Drag to your business location",
            animation: google.maps.Animation.DROP,
            icon: {
                url: "https://maps.google.com/mapfiles/ms/icons/green-dot.png"
            }
        });

        marker.addListener("dragstart", () => {
            document.getElementById('address-error').classList.add('hidden');
        });

        marker.addListener("dragend", () => {
            const pos = marker.getPosition();
            const distance = google.maps.geometry.spherical.computeDistanceBetween(pos, poortjieCenter);

            if (distance > 5000) {
                const heading = google.maps.geometry.spherical.computeHeading(poortjieCenter, pos);
                const newPos = google.maps.geometry.spherical.computeOffset(poortjieCenter, 4990, heading);
                marker.setPosition(newPos);
                updateAddressFromPos(newPos);
            } else {
                updateAddressFromPos(pos);
            }
            updatePreview();
        });

        map.addListener("click", (e) => {
            const distance = google.maps.geometry.spherical.computeDistanceBetween(e.latLng, poortjieCenter);
            if (distance <= 5000) {
                marker.setPosition(e.latLng);
                updateAddressFromPos(e.latLng);
                updatePreview();
            }
        });
    }

    function updateAddressFromPos(pos) {
        selectedLat = pos.lat();
        selectedLng = pos.lng();
        latitudeInput.value = selectedLat;
        longitudeInput.value = selectedLng;

        // Only set address to "Dropped Pin" if it's currently empty
        if (!modalAddressInput.value.trim()) {
            modalAddressInput.value = "Poortjie";
            isAddressSelectedFromAutocomplete = true;
        }
    }

    function initAutocomplete() {
        const poortjieCenter = {lat: -26.456323807221267, lng: 27.77044633885547};

        const circle = new google.maps.Circle({
            center: poortjieCenter,
            radius: 5000
        });

        // Using legacy Autocomplete as requested by the API key owner's environment, 
        // while acknowledging the migration path to PlaceAutocompleteElement.
        const autocomplete = new google.maps.places.Autocomplete(modalAddressInput, {
            bounds: circle.getBounds(),
            strictBounds: true,
            componentRestrictions: {country: "za"},
            fields: ["formatted_address", "geometry"],
            types: ["address"],
        });

        // Hide friendly message about legacy autocomplete
        const pacContainer = document.querySelector('.pac-container');
        if (pacContainer) pacContainer.style.zIndex = '1000';

        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (place.formatted_address) {
                modalAddressInput.value = place.formatted_address;
                isAddressSelectedFromAutocomplete = true;

                if (place.geometry && place.geometry.location) {
                    selectedLat = place.geometry.location.lat();
                    selectedLng = place.geometry.location.lng();
                    latitudeInput.value = selectedLat;
                    longitudeInput.value = selectedLng;

                    if (map && marker) {
                        marker.setPosition(place.geometry.location);
                        map.setCenter(place.geometry.location);
                    }
                }
            }
        });
    }
</script>
<script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXnSxBam3mjlfEx3F4XL_7ZIwLEbov0n8&loading=async&libraries=places,geometry&callback=initAutocomplete"></script>
    <!-- Login Required Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center hidden">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full mx-6">
            <h3 class="text-xl font-bold mb-4">Account Required</h3>
            <p class="opacity-70 mb-6">In order to list your business you need an account.</p>
            <div class="flex gap-4">
                <button id="close-login-modal" class="flex-1 py-3 border-2 border-gray-200 dark:border-slate-700 rounded-lg font-bold hover:bg-gray-50 dark:hover:bg-slate-700 transition">
                    Cancel
                </button>
                <button id="login-modal-btn" class="flex-1 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition">
                    Login
                </button>
            </div>
        </div>
    </div>
</body>
</html>
