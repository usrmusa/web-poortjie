<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management | Poortjie Services</title>
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#22c55e">

    <link rel="icon" type="image/png" sizes="48x48" href="../favicon/favicon-48x48.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../favicon/favicon-96x96.png">
    <link rel="icon" type="image/svg+xml" href="../favicon/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        if (window.console && window.console.log) {
            const originalLog = window.console.log;
            window.console.log = function() {
                if (arguments[0] && typeof arguments[0] === 'string' && (arguments[0].includes('cdn.tailwindcss.com should not be used in production') || arguments[0].includes('Tailwind CSS: You should not use the CDN'))) return;
                originalLog.apply(window.console, arguments);
            };
        }
    </script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="manifest" href="../favicon/site.webmanifest">
</head>
<body class="font-sans antialiased bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100">

<div id="admin-content" class="hidden">
    <header class="max-w-6xl mx-auto pt-24 pb-16 px-6">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-4xl font-extrabold tracking-tight">User Management</h1>
            <a href="../index.html"
               onclick="if(history.length > 1) { history.back(); return false; } else { window.top.location.replace('../index.html'); return false; }"
               class="w-full md:w-auto text-center px-6 py-3 border-2 border-green-600 text-green-600 dark:text-green-400 font-bold rounded-lg hover:bg-green-600 hover:text-white transition whitespace-nowrap">
                Back to Home
            </a>
        </div>
        <p class="text-xl opacity-80">View and manage all registered users.</p>
    </header>

    <main class="max-w-6xl mx-auto px-6 pb-24">
        <div class="card p-8 rounded-2xl mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold">All Users</h2>
                <div class="text-sm text-gray-500 dark:text-gray-400" id="user-count">Loading...</div>
            </div>

            <!-- Search and Sort -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <div class="relative flex-grow">
                    <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <label for="search-users"></label><input type="text" id="search-users" placeholder="Search by name or email..."
                           class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-green-500 transition">
                </div>
                <label for="sort-users"></label><select id="sort-users" class="px-4 py-3 rounded-lg border border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-green-500 transition">
                    <option value="joined_desc">Joined (Newest)</option>
                    <option value="joined_asc">Joined (Oldest)</option>
                    <option value="name_asc">Name (A-Z)</option>
                    <option value="name_desc">Name (Z-A)</option>
                </select>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                    <tr class="border-b border-gray-200 dark:border-gray-700">
                        <th class="py-4 px-4 font-bold text-sm uppercase text-gray-500 dark:text-gray-400">User</th>
                        <th class="py-4 px-4 font-bold text-sm uppercase text-gray-500 dark:text-gray-400">Email</th>
                        <th class="py-4 px-4 font-bold text-sm uppercase text-gray-500 dark:text-gray-400">Joined</th>
                        <th class="py-4 px-4 font-bold text-sm uppercase text-gray-500 dark:text-gray-400">Roles</th>
                    </tr>
                    </thead>
                    <tbody id="users-list" class="divide-y divide-gray-100 dark:divide-gray-800">
                    <!-- Users will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Image Modal -->
    <div id="image-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm" onclick="closeImageModal()">
        <div class="relative max-w-4xl max-h-full flex flex-col items-center" onclick="event.stopPropagation()">
            <img id="full-image" src="" alt="Full size" class="max-w-full max-h-[80vh] rounded-lg shadow-2xl mb-4">
            <h3 id="modal-user-name" class="text-white text-xl font-bold"></h3>
            <button onclick="closeImageModal()" class="absolute top-0 right-0 -mt-12 -mr-4 md:-mr-12 text-white hover:text-gray-300 p-2">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>
</div>

<script src="../scripts/theme.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="../scripts/firebase.js"></script>

<script>
    const usersList = document.getElementById('users-list');
    const userCount = document.getElementById('user-count');
    const searchInput = document.getElementById('search-users');
    const sortSelect = document.getElementById('sort-users');
    const imageModal = document.getElementById('image-modal');
    const fullImage = document.getElementById('full-image');
    const modalUserName = document.getElementById('modal-user-name');

    let allUsers = [];

    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            // Check if user is superuser
            db.collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists && doc.data().roles?.digilayn?.isSuperUser) {
                    document.getElementById('admin-content').classList.remove('hidden');
                    loadUsers();
                } else {
                    window.top.location.replace('../index.html');
                }
            }).catch(error => {
                console.error("Error checking permissions:", error);
                window.top.location.replace('../index.html');
            });
        } else {
            sessionStorage.setItem('redirectUrl', window.location.href);
            window.top.location.replace('../authentication/login.html');
        }
    });

    async function loadUsers() {
        try {
            const snapshot = await db.collection('users').get();
            allUsers = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                // Normalize joined date for sorting
                let joinedDate = new Date(0);
                if (data.createdAt && data.createdAt.seconds) {
                    joinedDate = new Date(data.createdAt.seconds * 1000);
                } else if (data.joinedAt && data.joinedAt.seconds) {
                    joinedDate = new Date(data.joinedAt.seconds * 1000);
                } else if (data.metadata?.creationTime) {
                    joinedDate = new Date(data.metadata.creationTime);
                }

                allUsers.push({
                    id: doc.id,
                    ...data,
                    _joinedDate: joinedDate
                });
            });

            filterAndSortUsers();
        } catch (error) {
            console.error("Error loading users:", error);
            userCount.textContent = "Error loading users";
        }
    }

    function filterAndSortUsers() {
        const searchTerm = searchInput.value.toLowerCase();
        const sortValue = sortSelect.value;

        // Filter
        let filtered = allUsers.filter(user => {
            const name = (user.displayName || '').toLowerCase();
            const email = (user.email || '').toLowerCase();
            return name.includes(searchTerm) || email.includes(searchTerm);
        });

        // Sort
        filtered.sort((a, b) => {
            if (sortValue === 'name_asc') {
                return (a.displayName || '').localeCompare(b.displayName || '');
            } else if (sortValue === 'name_desc') {
                return (b.displayName || '').localeCompare(a.displayName || '');
            } else if (sortValue === 'joined_asc') {
                return a._joinedDate - b._joinedDate;
            } else { // joined_desc (default)
                return b._joinedDate - a._joinedDate;
            }
        });

        userCount.textContent = `${filtered.length} users found`;
        renderUsers(filtered);
    }

    function getRolesBadges(user) {
        const roles = [];
        const r = user.roles || {};

        if (r.digilayn?.isSuperUser) roles.push({name: 'Super User', color: 'bg-purple-100 text-purple-700 border-purple-200'});

        if (r.kasilayn?.isAdmin) roles.push({name: 'Kasilayn Admin', color: 'bg-blue-100 text-blue-700 border-blue-200'});
        if (r.kasilayn?.isDriver) roles.push({name: 'Driver', color: 'bg-yellow-100 text-yellow-700 border-yellow-200'});

        if (r.poortjie?.isAdmin) roles.push({name: 'Poortjie Admin', color: 'bg-green-100 text-green-700 border-green-200'});
        if (r.poortjie?.isTaxiRankAdmin) roles.push({name: 'Taxi Rank Admin', color: 'bg-emerald-100 text-emerald-700 border-emerald-200'});

        if (r.lastpassing?.isAdmin) roles.push({name: 'LastPassing Admin', color: 'bg-gray-100 text-gray-700 border-gray-200'});

        if (roles.length === 0) return '<span class="px-2 py-1 text-xs font-bold rounded-full bg-slate-100 text-slate-600 border border-slate-200">User</span>';

        return roles.map(role =>
            `<span class="px-2 py-1 text-xs font-bold rounded-full border ${role.color} mr-1 mb-1 inline-block whitespace-nowrap">${role.name}</span>`
        ).join('');
    }

    function renderUsers(users) {
        usersList.innerHTML = users.map(user => {
            const joinedDisplay = user._joinedDate.getTime() > 0 ? user._joinedDate.toLocaleDateString() : 'N/A';
            const photoUrl = user.photoUrl || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'User')}&background=random`;
            const name = user.displayName || 'Anonymous';
            const email = user.email || 'No email';
            const rolesHtml = getRolesBadges(user);

            // Escape single quotes for onclick handler
            const safeName = name.replace(/'/g, "\\'");
            const safePhoto = photoUrl.replace(/'/g, "\\'");

            return `
                <tr class="hover:bg-gray-50 dark:hover:bg-slate-800/50 transition group">
                    <td class="py-4 px-4">
                        <div class="flex items-center">
                            <div class="relative cursor-pointer" onclick="openImageModal('${safePhoto}', '${safeName}')">
                                <img src="${photoUrl}" alt="${name}" class="w-10 h-10 rounded-full object-cover mr-3 border border-gray-200 dark:border-gray-700 group-hover:border-green-500 transition">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 rounded-full transition"></div>
                            </div>
                            <div>
                                <div class="font-bold text-slate-900 dark:text-slate-100">${name}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400 md:hidden">${email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="py-4 px-4 hidden md:table-cell text-slate-600 dark:text-slate-300">${email}</td>
                    <td class="py-4 px-4 text-slate-600 dark:text-slate-300 whitespace-nowrap">${joinedDisplay}</td>
                    <td class="py-4 px-4">
                        <div class="flex flex-wrap">
                            ${rolesHtml}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function openImageModal(url, name) {
        fullImage.src = url;
        modalUserName.textContent = name;
        imageModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeImageModal() {
        imageModal.classList.add('hidden');
        document.body.style.overflow = '';
    }

    // Event Listeners
    searchInput.addEventListener('input', filterAndSortUsers);
    sortSelect.addEventListener('change', filterAndSortUsers);

    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !imageModal.classList.contains('hidden')) {
            closeImageModal();
        }
    });
</script>
</body>
</html>