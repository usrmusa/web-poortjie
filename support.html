<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support | Poortjie Services</title>
    <meta name="author" content="Musa Mgijima">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        if (window.console && window.console.log) {
            const originalLog = window.console.log;
            window.console.log = function() {
                if (arguments[0] && typeof arguments[0] === 'string' && (arguments[0].includes('cdn.tailwindcss.com should not be used in production') || arguments[0].includes('Tailwind CSS: You should not use the CDN'))) return;
                originalLog.apply(window.console, arguments);
            };
        }
    </script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="icon" type="image/png" sizes="48x48" href="favicon/favicon-48x48.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon/favicon-96x96.png">
    <link rel="icon" type="image/svg+xml" href="favicon/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="manifest" href="favicon/site.webmanifest">
</head>
<body class="font-sans antialiased bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100 min-h-screen">

<header class="max-w-6xl mx-auto pt-24 pb-12 px-6 text-center">
    <a href="index.html"
       onclick="if(history.length > 1) { history.back(); return false; } else { window.top.location.replace('index.html'); return false; }"
       class="text-6xl font-extrabold mb-4 tracking-tight">Poortjie</a>
    <h2 class="text-2xl font-bold mt-4">Support & Suggestions</h2>
</header>

<main class="max-w-2xl mx-auto px-6 pb-24">

    <!-- Suggestions Form -->
    <div class="card p-8 rounded-2xl border-l-4 border-l-green-500 bg-white dark:bg-slate-800 shadow-lg mb-8">
        <h3 class="text-xl font-bold mb-4">Leave a Suggestion</h3>
        <p class="mb-6 opacity-80">Help us improve Poortjie Services. Your feedback is valuable!</p>
        
        <div id="auth-warning" class="hidden mb-6 p-4 rounded-lg bg-amber-100 text-amber-800 border border-amber-200">
            <p class="font-medium">Please login to leave a suggestion.</p>
            <a href="authentication/login.html" 
               onclick="sessionStorage.setItem('redirectUrl', window.location.href); window.location.href = 'authentication/login.html'; return false;"
               class="text-amber-900 font-bold underline">Login here</a>
        </div>

        <div id="suggestion-success" class="hidden mb-6 p-4 rounded-lg bg-green-100 text-green-800 border border-green-200">
            Thank you! Your suggestion has been submitted successfully.
        </div>

        <form id="suggestion-form" class="space-y-4">
            <div>
                <label for="subject" class="block mb-1 font-bold text-sm uppercase tracking-wider">Subject</label>
                <input type="text" id="subject" name="subject" required
                       class="w-full p-3 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
            </div>
            <div>
                <label for="message" class="block mb-1 font-bold text-sm uppercase tracking-wider">Message</label>
                <textarea id="message" name="message" rows="5" required
                          class="w-full p-3 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition"></textarea>
            </div>
            <button type="submit" id="submit-btn"
                    class="w-full px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                Submit Suggestion
            </button>
        </form>
    </div>

    <!-- Admin WhatsApp Links -->
    <div id="admin-contacts-section" class="hidden card p-8 rounded-2xl border-l-4 border-l-blue-500 bg-white dark:bg-slate-800 shadow-lg mb-8">
        <h3 class="text-xl font-bold mb-4">Chat with Poortjie Admins</h3>
        <p class="mb-6 opacity-80">Need immediate help? Reach out to one of our administrators on WhatsApp.</p>
        
        <div id="admins-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <!-- Admin links will be injected here -->
        </div>
    </div>

    <!-- Data & Privacy Policy -->
    <div class="card p-8 rounded-2xl border-l-4 border-l-amber-500 bg-white dark:bg-slate-800 shadow-lg mb-8">
        <h3 class="text-xl font-bold mb-4">Data & Privacy Policy</h3>
        <div class="space-y-4 text-sm opacity-90 leading-relaxed">
            <p>
                <span class="font-bold text-amber-600 dark:text-amber-400">Your Responsibility:</span> 
                By using Poortjie Services, you agree that you are solely responsible for any data, text, images, or other information you add or upload to the platform. You must ensure that your content is accurate and does not violate any laws or third-party rights.
            </p>
            <p>
                <span class="font-bold text-amber-600 dark:text-amber-400">Ownership:</span> 
                You retain full ownership of all content you upload. We do not claim any ownership rights over your data.
            </p>
            <p>
                <span class="font-bold text-amber-600 dark:text-amber-400">Hosting:</span> 
                Our platform is powered by <span class="font-bold">Google Firebase</span>. Your data is securely hosted on Google's infrastructure, ensuring high availability and protection.
            </p>
            <p>
                <span class="font-bold text-amber-600 dark:text-amber-400">Data Deletion:</span> 
                Your privacy is important to us. Upon request, we will delete your account and all associated data from our systems immediately. To request data deletion, please contact an admin via WhatsApp or submit a suggestion with the subject "Data Deletion".
            </p>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/90 p-4" onclick="closeModal()">
        <button class="absolute top-6 right-6 text-white text-4xl hover:text-gray-300 transition">&times;</button>
        <img id="modal-image" src="" alt="Full view" class="max-w-full max-h-full rounded-lg shadow-2xl transition-transform duration-300">
    </div>
</main>

<footer class="text-center py-12 border-t border-gray-100 dark:border-slate-800 opacity-50 text-xs">
    &copy; 2026 Poortjie Services. Empowering poortjie economies.
</footer>

<div class="mt-2 text-center opacity-50 text-[10px]">
    <a href="support.html" class="hover:underline">Data Policy</a>
</div>

<script src="scripts/theme.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="scripts/firebase.js"></script>

<script>
    const suggestionForm = document.getElementById('suggestion-form');
    const authWarning = document.getElementById('auth-warning');
    const successMessage = document.getElementById('suggestion-success');
    const submitBtn = document.getElementById('submit-btn');

    let currentUser = null;

    // Check auth state
    auth.onAuthStateChanged((user) => {
        currentUser = user;
        if (!user) {
            suggestionForm.classList.add('opacity-50', 'pointer-events-none');
            authWarning.classList.remove('hidden');
            submitBtn.disabled = true;
        } else {
            suggestionForm.classList.remove('opacity-50', 'pointer-events-none');
            authWarning.classList.add('hidden');
            submitBtn.disabled = false;
        }
    });

    suggestionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!currentUser) {
            alert('You must be logged in to submit a suggestion.');
            return;
        }

        const subject = document.getElementById('subject').value;
        const message = document.getElementById('message').value;

        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        try {
            await db.collection('suggestions').add({
                userId: currentUser.uid,
                userEmail: currentUser.email,
                subject: subject,
                message: message,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            suggestionForm.reset();
            successMessage.classList.remove('hidden');
            setTimeout(() => {
                successMessage.classList.add('hidden');
            }, 5000);
        } catch (error) {
            console.error("Error submitting suggestion: ", error);
            alert('Failed to submit suggestion. Please try again later.');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Suggestion';
        }
    });

    // Load and display random admins
    async function loadAdmins() {
        const adminsList = document.getElementById('admins-list');
        const adminSection = document.getElementById('admin-contacts-section');

        try {
            const querySnapshot = await db.collection('users').get();

            let admins = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                // Check if user is a Poortjie admin and has opted in to be listed
                if (data.roles?.poortjie?.isAdmin === true && data.phone && data.roles?.poortjie?.listForSupport === true) {
                    admins.push({
                        name: data.displayName || 'Admin',
                        phone: data.phone,
                        photoUrl: data.photoUrl || ''
                    });
                }
            });

            if (admins.length > 0) {
                // Shuffle admins
                admins.sort(() => Math.random() - 0.5);

                adminsList.innerHTML = admins.map(admin => {
                    const cleanPhone = admin.phone.startsWith('0') ? '27' + admin.phone.substring(1) : admin.phone;
                    const photoHtml = admin.photoUrl 
                        ? `<img src="${admin.photoUrl}" alt="${admin.name}" class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm cursor-pointer hover:scale-110 transition shrink-0" onclick="event.preventDefault(); expandImage('${admin.photoUrl}')">`
                        : `<div class="w-12 h-12 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400 shrink-0">
                                <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                </svg>
                           </div>`;

                    return `
                        <a href="https://wa.me/${cleanPhone}" target="_blank" 
                           class="flex items-center gap-4 p-4 rounded-xl bg-gray-50 dark:bg-slate-700/50 hover:bg-green-50 dark:hover:bg-green-900/20 border border-transparent hover:border-green-200 dark:hover:border-green-800 transition group">
                            ${photoHtml}
                            <div>
                                <div class="font-bold group-hover:text-green-600 dark:group-hover:text-green-400 transition">${admin.name}</div>
                                <div class="text-xs opacity-60">Available on WhatsApp</div>
                            </div>
                        </a>
                    `;
                }).join('');
                adminSection.classList.remove('hidden');
            }
        } catch (error) {
            console.error("Error loading admins: ", error);
        }
    }

    function expandImage(url) {
        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-image');
        modalImg.src = url;
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        const modal = document.getElementById('image-modal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    loadAdmins();
</script>
</body>
</html>
