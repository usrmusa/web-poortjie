<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | Poortjie Services</title>
    <meta name="author" content="Musa Mgijima">
    <meta name="description" content="Manage your Poortjie Services account.">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        if (window.console && window.console.log) {
            const originalLog = window.console.log;
            window.console.log = function() {
                if (arguments[0] && typeof arguments[0] === 'string' && (arguments[0].includes('cdn.tailwindcss.com should not be used in production') || arguments[0].includes('Tailwind CSS: You should not use the CDN'))) return;
                originalLog.apply(window.console, arguments);
            };
        }
    </script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="icon" type="image/png" sizes="48x48" href="../favicon/favicon-48x48.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../favicon/favicon-96x96.png">
    <link rel="icon" type="image/svg+xml" href="../favicon/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png">
    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <link rel="manifest" href="../favicon/site.webmanifest">
</head>
<body class="font-sans antialiased bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100">

<header class="max-w-6xl mx-auto pt-24 pb-16 px-6 text-center text-gray-900 dark:text-gray-100">
    <a href="../index.html"
       onclick="if(history.length > 1) { history.back(); return false; } else { window.top.location.replace('../index.html'); return false; }"
       class="text-6xl font-extrabold mb-4 tracking-tight">Poortjie</a>
</header>

<main class="max-w-md mx-auto px-6 pb-24">
    <div class="card flex flex-col p-8 rounded-2xl border-l-4 border-l-green-500">
        <h2 class="text-2xl font-bold mb-6 text-center">Your Profile</h2>
        <div id="status-message" class="hidden mb-4 p-3 rounded-lg text-sm font-medium border"></div>
        
        <form id="profile-form">
            <div class="flex flex-col items-center mb-6">
                <div class="relative group cursor-pointer">
                    <img id="profile-picture" src="https://placehold.co/150" alt="Profile Picture" class="w-32 h-32 rounded-full object-cover border-4 border-green-500 shadow-md transition transform hover:scale-105">
                    <label for="photo-input" class="absolute bottom-0 right-0 bg-green-600 text-white p-2 rounded-full cursor-pointer hover:bg-green-700 transition shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </label>
                    <input type="file" id="photo-input" accept="image/*" class="hidden">
                    <input type="hidden" id="photo-url" name="photo-url">
                </div>
                <p class="text-xs opacity-50 mt-2">Click icon to change picture</p>
            </div>

            <div class="mb-4">
                <label class="block text-xs opacity-50 mb-1 pl-1">Username (cannot be changed)</label>
                <label for="username"></label><input type="text" id="username" disabled class="w-full p-3 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-gray-400 border-2 border-transparent cursor-not-allowed">
            </div>
            <div class="mb-4">
                <label class="block text-xs opacity-50 mb-1 pl-1">Email (cannot be changed)</label>
                <label for="email"></label><input type="email" id="email" disabled class="w-full p-3 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-gray-400 border-2 border-transparent cursor-not-allowed">
            </div>
            <div class="mb-4">
                <label class="block text-xs opacity-50 mb-1 pl-1">Full Name (max 3 names)</label>
                <input type="text" id="display-name" name="display-name" placeholder="Full Name" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition" required pattern="^[A-Za-z]+(\s[A-Za-z]+){0,2}$" title="Please enter your full name (max 3 names).">
            </div>
            <div class="mb-4">
                <label class="block text-xs opacity-50 mb-1 pl-1">Phone Number (10 digits)</label>
                <input type="tel" id="phone-number" name="phone-number" placeholder="e.g. 0123456789" maxlength="10" pattern="\d{10}" title="Please enter exactly 10 digits" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
            </div>
            <div class="mb-6">
                <div class="flex justify-between items-center mb-1 pl-1">
                    <label class="block text-xs opacity-50">Bio / About</label>
                    <span id="bio-counter" class="text-xs opacity-50">0/100</span>
                </div>
                <label for="bio"></label><textarea id="bio" name="bio" rows="3" maxlength="100" placeholder="Tell us about yourself..." class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition"></textarea>
            </div>
            
            <div id="admin-toggle-section" class="hidden mb-6 p-4 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-bold text-blue-900 dark:text-blue-100">Support Listing</h3>
                        <p class="text-xs text-blue-700 dark:text-blue-300 opacity-80">Appear on the support page</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="list-for-support" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
            
            <button type="button" id="save-btn" class="w-full px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition shadow-md mb-4">
                Back
            </button>
        </form>

        <button id="logout-btn" class="w-full px-8 py-3 border-2 border-red-500 text-red-500 font-bold rounded-lg hover:bg-red-500 hover:text-white transition">
            Logout
        </button>
    </div>
</main>

<!-- Image Modal -->
<div id="image-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black bg-opacity-90 transition-opacity duration-300">
    <button id="close-modal" class="absolute top-6 right-6 text-white hover:text-gray-300 focus:outline-none">
        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
    </button>
    <img id="modal-image" src="" alt="Expanded Profile Picture" class="max-w-[90%] max-h-[90%] rounded-lg shadow-2xl transform transition-transform duration-300">
</div>

<!-- Crop Modal -->
<div id="crop-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center bg-black bg-opacity-90 p-4">
    <div class="bg-white dark:bg-slate-800 rounded-2xl max-w-lg w-full overflow-hidden shadow-2xl">
        <div class="p-4 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center">
            <h3 class="font-bold text-lg">Crop Profile Picture</h3>
            <button id="cancel-crop" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="p-4 max-h-[60vh] flex items-center justify-center bg-gray-50 dark:bg-slate-900">
            <img id="crop-image" src="" class="max-w-full" alt="">
        </div>
        <div class="p-4 flex gap-3">
            <button id="rotate-left" class="flex-1 py-2 bg-gray-100 dark:bg-slate-700 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-600 transition font-bold text-xs uppercase tracking-widest">
                <i class="fas fa-undo mr-1"></i> Left
            </button>
            <button id="rotate-right" class="flex-1 py-2 bg-gray-100 dark:bg-slate-700 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-600 transition font-bold text-xs uppercase tracking-widest">
                <i class="fas fa-redo mr-1"></i> Right
            </button>
        </div>
        <div class="p-4 bg-gray-50 dark:bg-slate-900 flex gap-3">
            <button id="apply-crop" class="flex-[2] py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 transition font-bold uppercase tracking-widest shadow-lg shadow-green-500/20">
                Apply Crop
            </button>
        </div>
    </div>
</div>

<footer class="text-center py-12 border-t border-gray-100 dark:border-slate-800 opacity-50 text-xs">
    &copy; 2026 Poortjie Services. Empowering poortjie economies.<br><a href="../support.html" class="hover:underline">Data Policy</a>
</footer>

<script src="../scripts/theme.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="../scripts/firebase.js"></script>

<script>
    const profileForm = document.getElementById('profile-form');
    const statusMessage = document.getElementById('status-message');
    const usernameInput = document.getElementById('username');
    const emailInput = document.getElementById('email');
    const displayNameInput = document.getElementById('display-name');
    const phoneNumberInput = document.getElementById('phone-number');
    const bioInput = document.getElementById('bio');
    const photoUrlInput = document.getElementById('photo-url');
    const photoInput = document.getElementById('photo-input');
    const profilePicture = document.getElementById('profile-picture');
    const saveBtn = document.getElementById('save-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const imageModal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    const closeModal = document.getElementById('close-modal');
    const bioCounter = document.getElementById('bio-counter');
    const adminToggleSection = document.getElementById('admin-toggle-section');
    const listForSupportToggle = document.getElementById('list-for-support');

    const cropModal = document.getElementById('crop-modal');
    const cropImage = document.getElementById('crop-image');
    const applyCropBtn = document.getElementById('apply-crop');
    const cancelCropBtn = document.getElementById('cancel-crop');
    const rotateLeftBtn = document.getElementById('rotate-left');
    const rotateRightBtn = document.getElementById('rotate-right');
    let cropper = null;

    const DEFAULT_AVATAR = "https://placehold.co/150";
    let initialData = {};

    function showStatus(message, isError = false) {
        statusMessage.textContent = message;
        statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'border-red-200', 'bg-green-100', 'text-green-700', 'border-green-200');
        if (isError) {
            statusMessage.classList.add('bg-red-100', 'text-red-700', 'border-red-200');
        } else {
            statusMessage.classList.add('bg-green-100', 'text-green-700', 'border-green-200');
        }
        statusMessage.classList.remove('hidden');
        setTimeout(() => {
            statusMessage.classList.add('hidden');
        }, 5000);
    }

    function checkChanges() {
        const currentData = {
            displayName: displayNameInput.value.trim(),
            phone: phoneNumberInput.value.trim(),
            bio: bioInput.value.trim(),
            photoUrl: photoUrlInput.value,
            listForSupport: listForSupportToggle.checked
        };

        const hasChanged = 
            currentData.displayName !== initialData.displayName ||
            currentData.phone !== initialData.phone ||
            currentData.bio !== initialData.bio ||
            currentData.photoUrl !== initialData.photoUrl ||
            currentData.listForSupport !== initialData.listForSupport;

        if (hasChanged) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Changes';
            saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            saveBtn.type = 'submit';
        } else {
            saveBtn.disabled = false; // Enabled for "Back" functionality
            saveBtn.textContent = 'Back';
            saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            saveBtn.type = 'button';
        }
    }

    saveBtn.addEventListener('click', (e) => {
        if (saveBtn.textContent === 'Back') {
            if (history.length > 1) {
                history.back();
            } else {
                window.location.replace('../index.html');
            }
        }
    });

    [displayNameInput, phoneNumberInput, bioInput, listForSupportToggle].forEach(input => {
        const eventName = input.type === 'checkbox' ? 'change' : 'input';
        input.addEventListener(eventName, () => {
            if (input === bioInput) {
                bioCounter.textContent = `${input.value.length}/100`;
            }
            checkChanges();
        });
    });

    phoneNumberInput.addEventListener('keypress', (e) => {
        if (!/\d/.test(e.key)) {
            e.preventDefault();
        }
    });

    profilePicture.addEventListener('click', () => {
        modalImage.src = profilePicture.src;
        imageModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    });

    closeModal.addEventListener('click', () => {
        imageModal.classList.add('hidden');
        document.body.style.overflow = '';
    });

    imageModal.addEventListener('click', (e) => {
        if (e.target === imageModal) {
            imageModal.classList.add('hidden');
            document.body.style.overflow = '';
        }
    });

    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            emailInput.value = user.email;
            firebase.firestore().collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    usernameInput.value = userData.username || '';
                    displayNameInput.value = userData.displayName || '';
                    phoneNumberInput.value = userData.phone || '';
                    bioInput.value = userData.bio || '';
                    photoUrlInput.value = userData.photoUrl || '';
                    profilePicture.src = userData.photoUrl || DEFAULT_AVATAR;
                    
                    if (userData.roles?.poortjie?.isAdmin === true) {
                        adminToggleSection.classList.remove('hidden');
                        listForSupportToggle.checked = userData.roles?.poortjie?.listForSupport === true;
                    }

                    initialData = {
                        displayName: displayNameInput.value.trim(),
                        phone: phoneNumberInput.value.trim(),
                        bio: bioInput.value.trim(),
                        photoUrl: photoUrlInput.value,
                        listForSupport: listForSupportToggle.checked
                    };
                    bioCounter.textContent = `${bioInput.value.length}/100`;
                    checkChanges();
                }
            }).catch(error => {
                console.error("Error fetching user data:", error);
                showStatus("Error loading profile data.", true);
            });
        } else {
            window.location.replace('login.html');
        }
    });

    photoInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            cropImage.src = event.target.result;
            cropModal.classList.remove('hidden');
            
            if (cropper) {
                cropper.destroy();
            }
            
            cropper = new Cropper(cropImage, {
                aspectRatio: 1,
                viewMode: 1,
                guides: true,
                background: false,
                autoCropArea: 1,
                responsive: true
            });
        };
        reader.readAsDataURL(file);
    });

    applyCropBtn.addEventListener('click', () => {
        if (!cropper) return;
        
        const canvas = cropper.getCroppedCanvas({
            width: 800,
            height: 800
        });
        
        let quality = 0.9;
        let dataUrl = canvas.toDataURL('image/jpeg', quality);
        
        while (dataUrl.length * 0.75 > 1024 * 1024 && quality > 0.1) {
            quality -= 0.1;
            dataUrl = canvas.toDataURL('image/jpeg', quality);
        }
        
        profilePicture.src = dataUrl;
        photoUrlInput.value = dataUrl;
        
        cropModal.classList.add('hidden');
        cropper.destroy();
        cropper = null;
        checkChanges();
    });

    cancelCropBtn.addEventListener('click', () => {
        cropModal.classList.add('hidden');
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        photoInput.value = '';
    });

    rotateLeftBtn.addEventListener('click', () => cropper && cropper.rotate(-90));
    rotateRightBtn.addEventListener('click', () => cropper && cropper.rotate(90));

    profileForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const user = firebase.auth().currentUser;
        if (!user) return;

        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        const newDisplayName = displayNameInput.value.trim();
        const newPhoneNumber = phoneNumberInput.value.trim();
        const newBio = bioInput.value.trim();
        const newPhotoUrl = photoUrlInput.value;
        const newListForSupport = listForSupportToggle.checked;

        firebase.firestore().collection('users').doc(user.uid).update({
            displayName: newDisplayName,
            phone: newPhoneNumber,
            bio: newBio,
            photoUrl: newPhotoUrl,
            "roles.poortjie.listForSupport": newListForSupport,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            showStatus("Profile updated successfully!");
            // Update initialData to current values after successful save
            initialData = {
                displayName: newDisplayName,
                phone: newPhoneNumber,
                bio: newBio,
                photoUrl: newPhotoUrl,
                listForSupport: newListForSupport
            };
            checkChanges();
            // Also update the auth profile if possible
            user.updateProfile({
                displayName: newDisplayName,
                photoURL: newPhotoUrl
            }).catch(err => console.error("Error updating auth profile:", err));
        }).catch(error => {
            console.error("Error updating profile:", error);
            showStatus("Error updating profile. Please try again.", true);
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Changes';
        });
    });

    logoutBtn.addEventListener('click', () => {
        firebase.auth().signOut().then(() => {
            window.top.location.replace('../index.html');
        }).catch(error => {
            console.error("Logout failed:", error);
            // Fallback: force redirect even if signOut fails
            window.top.location.replace('../index.html');
        });
    });

    displayNameInput.addEventListener('blur', (e) => {
        let value = e.target.value.trim().replace(/\s+/g, ' ');
        if (value) {
            const words = value.split(' ');
            const formattedWords = words.slice(0, 3).map(word => {
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            });
            e.target.value = formattedWords.join(' ');
        }
        checkChanges();
    });
</script>
</body>
</html>
